# Техническое задание
## Система финансового учета (fin_count)

**Версия документа:** 2.2  
**Дата создания:** 07.11.2025  
**Дата обновления:** 09.11.2025  
**Проект:** fin_count  
**Версия проекта:** 0.0.1  
**Статус проекта:** В разработке документации

---

## 1. Общие сведения

### 1.1. Назначение системы
Система предназначена для ведения финансового учета с поддержкой мультивалютного учета, управления подотчетными средствами и ведения журнала операций.

### 1.2. Технологический стек
- **Backend:** Django 5.2.8
- **База данных:** 
  - SQLite (для разработки)
  - PostgreSQL (для промышленного применения)
- **Язык:** Python 3.11
- **Интерфейс:** Django Admin + пользовательские формы

### 1.3. Требования к системе
- Python 3.11+
- Django 5.2.8
- Виртуальная среда Python (рекомендуется для изоляции зависимостей проекта)
- База данных:
  - SQLite (для разработки) - встроена в Python
  - PostgreSQL (для промышленного применения) - требуется установка и настройка
- Поддержка мультивалютного учета
- Режим отладки для разработки
- Доступ на всех IP-адресах рабочего места

**Примечание:** Подробная информация о создании и использовании виртуальной среды Python описана в разделе 7.7.1.

---

## 2. Функциональные требования

### 2.1. Основные функции системы

Система должна обеспечивать выполнение следующих функций:

#### 2.1.1. Учет остатков денежных средств
- Учет остатков денежных средств по кассам в различных валютах
- Расчет остатков на произвольную дату
- Хранение остатков в системе (динамический расчет на основе операций)
- Отображение остатков по каждой кассе и валюте

#### 2.1.2. Учет подотчетных средств
- Учет остатков по выданным авансам сотрудникам
- Расчет остатков неотчитанных средств по каждому сотруднику
- Расчет остатков по конкретной выдаче подотчетных средств
- Учет только подтвержденных авансовых отчетов при расчете остатков

#### 2.1.3. Оформление операций документами
Система должна поддерживать следующие типы документов:
- **Оприходование денег** - документ поступления денежных средств в кассу
- **Расход денег** - документ расхода денежных средств из кассы
- **Выдача денег подотчетному лицу (сотруднику)** - документ выдачи подотчетных средств
- **Авансовые отчеты** - документы по фактическим тратам сотрудника
- **Возврат денег сотрудником** - отдельный документ возврата неиспользованных средств (полный или частичный возврат от выдачи)
- **Дополнительная выдача подотчетных средств** - документ дополнительной выдачи, привязанный к первоначальной выдаче
- **Перемещение между кассами** - документ перемещения денежных средств между кассами
- **Конвертация валют** - документ конвертации одной валюты в другую

#### 2.1.4. Журнал операций
- Ведение общего журнала операций со ссылками на:
  - Документы (все типы документов)
  - Физические лица (сотрудники)
  - Валюты
  - Статьи расходов и доходов
- Автоматическое создание записей в журнале при создании документов
- Обновление записей при редактировании документов
- Удаление записей при удалении документов

#### 2.1.5. Справочники
- Ведение справочника валют
- Ведение справочника касс
- Ведение справочника статей расходов и доходов (с поддержкой иерархии)
- Ведение справочника сотрудников

---

### 2.2. Требования к справочникам

#### 2.2.1. Справочник валют
- Возможность добавления, редактирования и деактивации валют
- Уникальность кода валюты (ISO 4217)
- Отображение символа валюты
- Фильтрация по активности
- Поиск по коду и названию

#### 2.2.2. Справочник касс
- Возможность добавления, редактирования и деактивации касс
- Отображение остатков по валютам в списке касс
- Расчет остатков на произвольную дату
- Фильтрация по активности

#### 2.2.3. Справочник статей доходов/расходов
- Возможность добавления, редактирования и деактивации статей
- Разделение на доходы и расходы
- Поддержка иерархической структуры (родитель-потомок)
- Фильтрация по типу и активности

#### 2.2.4. Справочник сотрудников
- Возможность добавления, редактирования и деактивации сотрудников
- Хранение ФИО и должности
- Расчет остатков подотчетных средств по сотруднику
- Фильтрация по активности
- Поиск по ФИО и должности

---

### 2.3. Требования к документам

#### 2.3.1. Оприходование денег
- Создание документа с указанием кассы, валюты, суммы, статьи доходов
- Автоматическое создание операции в журнале операций при сохранении документа
- Обновление операции при редактировании документа
- Фильтрация по кассе, валюте, статье доходов, сотруднику

#### 2.3.2. Расход денег
- Создание документа с указанием кассы, валюты, суммы, статьи расходов
- Автоматическое создание операции в журнале операций при сохранении документа
- Обновление операции при редактировании документа
- Фильтрация по кассе, валюте, статье расходов, сотруднику

#### 2.3.3. Выдача денег подотчетному лицу (сотруднику)
- Создание документа с указанием сотрудника, кассы, суммы, валюты, статьи расходов, цели выдачи
- Автоматическое создание операции в журнале операций (расход из кассы)
- Обновление операции при редактировании документа
- Отображение остатка неотчитанных средств в списке выдач
- Возможность закрытия выдачи (автоматически или вручную)
- Фильтрация по сотруднику, валюте, статье расходов, статусу закрытия

#### 2.3.4. Авансовый отчет
- Создание документа с привязкой к выданным подотчетным средствам
- Добавление строк отчета с указанием статьи расходов, суммы, описания, даты расхода
- Автоматический расчет общей суммы из суммы всех строк
- Автоматический расчет суммы возврата и доплаты
- Возможность ручного указания сумм возврата и доплаты
- Статусы отчета (значение в коде → отображаемое имя): `draft` → «Черновик», `submitted` → «Сдан», `approved` → «Подтвержден», `rejected` → «Отклонен»
- **Только подтвержденные отчеты отражаются в движениях по остаткам**
- При подтверждении отчета:
  - Создание операций построчно по каждой строке отчета
  - Создание операции возврата (если есть возврат в рамках отчета)
  - Создание операции доплаты (если есть доплата)
  - Возможность закрытия подотчетных средств или создания новой выдачи при доплате
- Обновление операций при редактировании подтвержденного отчета
- Удаление операций для удаленных строк отчета
- Встроенное редактирование строк отчета (inline-редактирование)
- Поле `description` («Описание») в строках — однострочное
- Фильтрация по сотруднику, статусу, валюте
- **Примечание:** Возврат денег может осуществляться как в рамках авансового отчета, так и отдельным документом возврата (AdvanceReturn)

---

**Требование:** При закрытии (подтверждении) сотрудником ранее выданных подотчетных средств в авансовом отчете, строки отчета должны использовать строго ту же статью расходов, по которой была произведена первоначальная выдача денег.

**Валидация:** Система должна проверять соответствие статей расходов в строках авансового отчета (AdvanceReportItem.item) статье расходов, указанной при выдаче подотчетных средств (AdvancePayment.expense_item). При несоответствии система должна блокировать сохранение отчета до исправления статьи расходов.

---

#### 2.3.5. Перемещение между кассами
- Создание документа с указанием исходной и целевой кассы, валюты, суммы
- Автоматическое создание двух операций:
  - Списание из исходной кассы (отрицательная сумма)
  - Поступление в целевую кассу (положительная сумма)

#### 2.3.6. Конвертация валют
- Создание документа с указанием исходной и целевой валюты, кассы, сумм, курса обмена
- Автоматическое создание двух операций:
  - Списание исходной валюты (отрицательная сумма)
  - Поступление целевой валюты (положительная сумма)

#### 2.3.7. Возврат денег сотрудником
- Создание отдельного документа возврата денег с привязкой к выданным подотчетным средствам (AdvancePayment)
- Указание сотрудника, кассы, суммы возврата, валюты
- Возможность полного или частичного возврата от первоначальной выдачи
- Автоматическое создание операции в журнале операций (положительная сумма - поступление в кассу)
- Обновление операции при редактировании документа
- Влияние на расчет остатков подотчетных средств
- Фильтрация по сотруднику, валюте, связанной выдаче

#### 2.3.8. Дополнительная выдача подотчетных средств
- Создание документа дополнительной выдачи с привязкой к первоначальной выдаче (AdvancePayment)
- Указание кассы, суммы дополнительной выдачи, валюты, цели выдачи
- Сотрудник берется автоматически из первоначальной выдачи (не требуется отдельное указание)
- Автоматическое создание операции в журнале операций (отрицательная сумма - расход из кассы)
- Обновление операции при редактировании документа
- Влияние на расчет остатков подотчетных средств
- Фильтрация по валюте, связанной первоначальной выдаче (сотрудник определяется через первоначальную выдачу)

---

### 2.4. Требования к журналу операций

#### 2.4.1. Общие требования
- Отображение всех операций с указанием типа, даты, суммы, кассы, валюты
- Связь операций с документами через ForeignKey
- Связь операций с сотрудниками, статьями доходов/расходов
- Дата операции устанавливается по дате документа
- Сумма может быть положительной (поступление) или отрицательной (расход)

#### 2.4.2. Типы операций
- Оприходование денег
- Расход денег
- Выдача подотчетных
- Авансовый отчет (строка отчета)
- Возврат денег сотрудником (отдельный документ возврата)
- Возврат денег по авансовому отчету (в рамках авансового отчета)
- Дополнительная выдача подотчетных средств
- Доплата по авансовому отчету
- Перемещение между кассами
- Конвертация валют

#### 2.4.3. Фильтрация и поиск
- Фильтры по типу, валюте, кассе, дате, сотруднику, статье
- Иерархия дат для навигации
- Поиск по описанию
- Отображение всех связей с документами

---

### 2.5. Требования к расчету остатков

#### 2.5.1. Остатки по кассам
- Расчет на основе всех операций по кассе и валюте
- Поддержка расчета на произвольную дату
- Динамический расчет (не хранятся в базе, рассчитываются по запросу)
- Метод: `CashRegister.get_balance(currency, date=None)`

#### 2.5.2. Остатки по выданным авансам
- **Формула расчета остатка:**
  ```
  Остаток = (Выдача подотчетных средств + Дополнительная выдача подотчетных средств) 
            - Авансовый отчет (подтвержденный) 
            - (Возврат денег сотрудником + возвраты по авансовым отчетам) 
            + доплаты по авансовым отчетам
  ```
- **Компоненты расчета:**
  - Выданные суммы: сумма первоначальной выдачи подотчетных средств (AdvancePayment) и всех дополнительных выдач подотчетных средств (AdditionalAdvancePayment)
  - Подтвержденные отчеты: сумма всех подтвержденных авансовых отчетов (AdvanceReport) по данной выдаче
  - Возвраты: сумма всех возвратов (отдельные документы возврата денег сотрудником (AdvanceReturn) + возвраты по авансовым отчетам)
  - Доплаты: сумма всех доплат по авансовым отчетам
- **Условие закрытия выдачи:** Выдача считается закрытой, когда остаток равен нулю, т.е. когда сумма всех подтвержденных отчетов равна сумме выдачи с учетом возвратов и доплат (см. раздел 2.5.3)
- Учет только операций из подтвержденных авансовых отчетов
- Учет всех операций возврата (отдельные документы и возвраты по авансовым отчетам)
- Учет всех дополнительных выдач подотчетных средств
- Динамический расчет (не хранятся в базе, рассчитываются по запросу)
- Метод: `Employee.get_advance_balance(currency)` - остаток по сотруднику
- Метод: `AdvancePayment.get_unreported_balance()` - остаток по конкретной выдаче (с учетом дополнительных выдач, возвратов и доплат)

#### 2.5.3. Закрытие выдачи подотчетных средств
- Каждый документ выдачи денег может быть закрыт одним или несколькими авансовыми отчетами
- Выдача считается закрытой, когда сумма всех подтвержденных отчетов по ней равна сумме выдачи (с учетом возвратов и доплат)

---

### 2.6. Требования к отчетам

Система должна обеспечивать формирование следующих отчетов:

#### 2.6.1. Отчет о текущем состоянии остатков по кассам
- Форма выбора даты отчета
- Таблица с остатками по всем кассам и валютам на выбранную дату
- Строка итогов по каждой валюте
- Отображение нулевых остатков
- URL: `/reports/cash-balance/`

#### 2.6.2. Отчет об операциях и движениях денег за период
- Форма выбора периода (дата начала и дата окончания)
- Форма выбора кассы (опционально, для фильтрации)
- Форма выбора валюты (опционально, для фильтрации)
- Таблица с операциями за период:
  - Дата операции
  - Тип операции
  - Документ-основание
  - Сотрудник (если применимо)
  - Статья доходов/расходов
  - Сумма (положительная или отрицательная)
  - Описание
- Входящий остаток на начало периода (по каждой кассе и валюте)
- Исходящий остаток на конец периода (по каждой кассе и валюте)
- Обороты за период (приход и расход)
- Итоги по кассам и валютам
- URL: `/reports/transactions-period/`

#### 2.6.3. Отчет об остатках по подотчетным деньгам
- Форма выбора даты отчета
- Форма выбора сотрудника (опционально, для фильтрации)
- Форма выбора валюты (опционально, для фильтрации)
- Таблица с остатками по подотчетным средствам:
  - Сотрудник
  - Валюта
  - Выданная сумма (сумма всех выдач)
  - Отчитанная сумма (сумма всех подтвержденных отчетов)
  - Возвращенная сумма (сумма всех возвратов)
  - Доплаченная сумма (сумма всех доплат)
  - Текущий остаток (неотчитанные средства)
- Детализация по каждому сотруднику:
  - Список выдач подотчетных средств с датами и суммами
  - Список авансовых отчетов с датами, суммами, статусами
  - Список возвратов денег с датами и суммами
  - Список доплат с датами и суммами
- Итоги по валютам
- URL: `/reports/advance-balance/`

#### 2.6.4. Отчет «Касса по дням»
- Форма выбора периода (дата начала и дата окончания)
- Форма выбора сотрудника (опционально, для фильтрации)
- Форма выбора валюты (опционально, для фильтрации)
- Таблица с операциями по подотчетным средствам:
  - № документа выдачи / возврата / авансового отчета
  - От кого получено или кому выдано (сотрудник)
  - Приход (положительные суммы)
  - Расход (отрицательные суммы)
  - Основание (описание)
- Итоги по приходу и расходу
- URL: `/reports/advance-operations/`

#### 2.6.5. Отчет «Расход денежных средств по статьям»
- Форма выбора периода (дата начала и дата окончания)
- Форма выбора кассы (опционально, для фильтрации)
- Форма выбора валюты (опционально, для фильтрации)
- Таблица с группировкой по статьям расходов:
  - Статья расходов
  - Строки с датами документов расхода по кассе
  - Остатки не подтвержденных или не возвращенных денег
- Итоги по статьям расходов
- URL: `/reports/expenses-by-items/`

---

### 2.7. Требования к интерфейсу

#### 2.7.1. Общие требования
- Интерфейс полностью на русском языке
- Все модели зарегистрированы в Django Admin
- Поддержка фильтров и поиска для всех моделей
- Использование `raw_id_fields` для оптимизации при большом количестве записей
- Использование `autocomplete_fields` где необходимо

#### 2.7.2. Требования к формам
- Автоматический расчет сумм в формах (общая сумма авансового отчета, возврат, доплата)
- Inline-редактирование строк авансового отчета
- Однострочное поле description в строках авансового отчета
- Валидация данных на уровне форм

---

## 3. Модели данных

### 3.1. Абстрактные базовые модели

В системе используются 4 абстрактные базовые модели, которые определяют общую структуру и поведение для всех объектов системы:

**Общие требования к реализации:**
- Абстрактные модели BaseDocument и BaseReference должны использовать UUID (GUID) в качестве первичного ключа
- Регистры (BaseOperationRegister, BaseAccumulationRegister) могут использовать стандартный автоинкрементный первичный ключ
- UUID обеспечивает уникальность записей и удобен для распределенных систем

#### 3.1.1. BaseDocument (Документ)
**Назначение:** Базовая модель для всех документов системы

**Поля:**
- `id` (UUIDField, primary_key=True, default=uuid.uuid4, editable=False) - Уникальный идентификатор (GUID)
- `number` (CharField, max_length=50, blank=True) - Номер документа (может быть введен вручную до 50 символов или сгенерирован автоматически)
- `date` (DateTimeField) - Дата документа (устанавливается автоматически при сохранении, если не указана)
- `is_posted` (BooleanField, default=False) - Статус "Проведен" (отражен в учете)
- `is_deleted` (BooleanField, default=False) - Пометка на удаление
- `created_at` (DateTimeField, auto_now_add=True) - Дата создания
- `updated_at` (DateTimeField, auto_now=True) - Дата обновления

**Логика поля `is_posted`:**
- Поле `is_posted` устанавливается в `true` автоматически для документов, которые отразились в операциях и регистрах
- Когда документ создает операции в журнале операций (Transaction), поле `is_posted` устанавливается в `true`
- Для документов, которые не создают операции (например, черновики авансовых отчетов), поле остается `false`
- Для авансовых отчетов: `is_posted` устанавливается в `true` только при подтверждении отчета (status='confirmed'), когда создаются операции
- При изменении статуса авансового отчета с 'confirmed' на другой и удалении операций, поле `is_posted` может быть установлено в `false`

**Логика поля `is_deleted`:**
- Поле `is_deleted` используется для пометки документа на удаление (мягкое удаление)
- При установке `is_deleted` в `true` автоматически устанавливается `is_posted` в `false`
- Документ с `is_deleted=True` не отражается в операциях и регистрах при расчетах
- Этот признак указывает, что документ может быть безболезненно удален из системы
- Документы с `is_deleted=True` исключаются из всех расчетов остатков и отчетов
- Операции, связанные с документом с `is_deleted=True`, также не учитываются в расчетах
- Документ с `is_deleted=True` можно восстановить, установив поле обратно в `false` (при этом `is_posted` не устанавливается автоматически)

**Ограничения уникальности:**
- Уникальность номера обеспечивается в рамках типа документа и периода (год) через `UniqueConstraint` в Meta классе
- Составной уникальный индекс: (тип документа, номер, год из даты документа)

**Методы:**
- `save()` - Автоматически устанавливает дату на текущий момент, если она не указана. Автоматически генерирует номер документа, если он не указан.
- `generate_document_number()` - Генерирует уникальный номер документа для типа документа и периода (год)

**Генерация номера документа:**
- Номер документа может быть введен вручную пользователем (максимальная длина - 50 символов)
- Если номер пустой, он генерируется автоматически при сохранении документа
- Если номер введен вручную, автоматическая генерация не выполняется
- Уникальность номера обеспечивается в рамках типа документа и периода (год)
- **Автоматически сгенерированный номер:**
  - Формат номера: `SC0000001`, где:
    - `SC` - глобальный префикс системы (устанавливается в настройках, длина 2 символа)
    - `0000001` - номер счетчика с лидирующими нулями (длина 7 символов)
  - Общая длина автоматически сгенерированного номера - 9 символов
  - Для каждого типа документа ведется отдельный счетчик
  - Алгоритм генерации:
    1. Определяется тип документа (класс модели)
    2. Определяется период (год из даты документа)
    3. Извлекается глобальный префикс из настроек системы
    4. Находится максимальный номер в периоде среди всех документов данного типа с таким префиксом
    5. Из максимального номера извлекается числовая часть
    6. К числовой части прибавляется 1
    7. Числовая часть дополняется лидирующими нулями до 7 символов
    8. Формируется новый номер: префикс + числовая часть
  - Если документов данного типа в периоде нет, счетчик начинается с 1 (номер: `SC0000001`)
- **Ручной ввод номера:**
  - Пользователь может ввести номер документа вручную
  - Максимальная длина введенного номера - 50 символов
  - Введенный номер должен быть уникальным в рамках типа документа и периода (год)

**Наследуют:**
- IncomeDocument (Оприходование денег)
- ExpenseDocument (Расход денег)
- AdvancePayment (Выдача денег подотчетному лицу)
- AdvanceReport (Авансовый отчет)
- AdvanceReturn (Возврат денег сотрудником)
- AdditionalAdvancePayment (Дополнительная выдача подотчетных средств)
- CashTransfer (Перемещение между кассами)
- CurrencyConversion (Конвертация валют)

---

#### 3.1.2. BaseOperationRegister (Регистр операций)
**Назначение:** Базовая модель для регистра операций (журнала операций)

**Поля:**
- `date` (DateTimeField) - Дата операции
- `transaction_type` (CharField, choices) - Тип операции
- `amount` (DecimalField) - Сумма операции
- `description` (TextField, blank=True) - Описание операции
- `created_at` (DateTimeField, auto_now_add=True) - Дата создания записи
- `created_by` (ForeignKey, User, null=True, blank=True) - Создано пользователем

**Особенности:**
- Регистр операций не имеет остатков, только движения
- Каждая операция отражает факт хозяйственной деятельности
- Операции привязываются к документам через ForeignKey

**Наследуют:**
- Transaction (Операция / Журнал операций)

---

#### 3.1.3. BaseAccumulationRegister (Регистр накоплений)
**Назначение:** Базовая модель для регистров накоплений (остатков)

**Поля:**
- `date` (DateTimeField) - Дата записи
- `period` (DateField) - Период (для расчета остатков на дату)
- `created_at` (DateTimeField, auto_now_add=True) - Дата создания записи

**Особенности:**
- Регистр накоплений хранит остатки и обороты
- Остатки рассчитываются на основе операций из регистра операций
- Поддерживает расчет остатков на произвольную дату

**Использование:**
- Остатки по кассам (CashRegister.get_balance)
- Остатки по выданным авансам (Employee.get_advance_balance)
- Остатки рассчитываются динамически на основе операций из регистра операций

---

#### 3.1.4. BaseReference (Справочники)
**Назначение:** Базовая модель для всех справочников системы

**Поля:**
- `id` (UUIDField, primary_key=True, default=uuid.uuid4, editable=False) - Уникальный идентификатор (GUID)
- `name` (CharField, max_length=200) - Название элемента справочника
- `code` (CharField, max_length=50, blank=True, null=True) - Код элемента (может быть введен вручную до 50 символов или сгенерирован автоматически)
- `description` (TextField, blank=True) - Описание
- `is_active` (BooleanField, default=True) - Активен
- `created_at` (DateTimeField, auto_now_add=True) - Дата создания
- `updated_at` (DateTimeField, auto_now=True) - Дата обновления

**Особенности:**
- Справочники содержат относительно статичную информацию
- Элементы справочников используются в документах и операциях
- Поддержка иерархической структуры через поле `parent` (опционально)

**Ограничения уникальности:**
- Уникальность кода обеспечивается в рамках типа справочника через `UniqueConstraint` в Meta классе конкретных моделей
- Составной уникальный индекс: (тип справочника, код)

**Методы:**
- `save()` - Автоматически генерирует код справочника, если он не указан
- `generate_reference_code()` - Генерирует уникальный код справочника для типа справочника

**Генерация кода справочника:**
- Код справочника может быть введен вручную пользователем (максимальная длина - 50 символов)
- Если код пустой, он генерируется автоматически при сохранении элемента справочника
- Если код введен вручную, автоматическая генерация не выполняется
- Уникальность кода обеспечивается в рамках типа справочника
- **Автоматически сгенерированный код:**
  - Формат кода: `SC0000001`, где:
    - `SC` - глобальный префикс системы (устанавливается в настройках, длина 2 символа, используется тот же префикс, что и для номеров документов)
    - `0000001` - номер счетчика с лидирующими нулями (длина 7 символов)
  - Общая длина автоматически сгенерированного кода - 9 символов
  - Для каждого типа справочника ведется отдельный счетчик
  - Алгоритм генерации:
    1. Определяется тип справочника (класс модели)
    2. Извлекается глобальный префикс из настроек системы
    3. Находится максимальный код среди всех элементов данного типа справочника с таким префиксом
    4. Из максимального кода извлекается числовая часть
    5. К числовой части прибавляется 1
    6. Числовая часть дополняется лидирующими нулями до 7 символов
    7. Формируется новый код: префикс + числовая часть
  - Если элементов данного типа справочника нет, счетчик начинается с 1 (код: `SC0000001`)
- **Ручной ввод кода:**
  - Пользователь может ввести код справочника вручную
  - Максимальная длина введенного кода - 50 символов
  - Уникальность введенного кода проверяется в рамках типа справочника
  - Если введенный код не уникален в рамках типа справочника, система блокирует сохранение с сообщением об ошибке

**Примечание:** Для модели `Currency` поле `code` переопределено и используется для кода валюты по ISO 4217 (например, "USD", "RUB"), поэтому автоматическая генерация кода не применяется. Для остальных справочников (CashRegister, IncomeExpenseItem, Employee, CurrencyRate) код генерируется автоматически, если не указан вручную.

**Наследуют:**
- Currency (Валюта)
- CashRegister (Касса)
- IncomeExpenseItem (Статья доходов/расходов)
- Employee (Сотрудник)

---

### 3.2. Справочники

Все справочники наследуются от `BaseReference` и дополняют базовую модель специфичными полями.

**Примечание:** Все справочники, наследующиеся от `BaseReference`, автоматически получают UUID (GUID) в качестве первичного ключа.

#### 3.2.1. Currency (Валюта)
**Назначение:** Справочник валют

**Наследует:** BaseReference

**Дополнительные поля:**
- `code` (CharField, max_length=3, unique=True) - Код валюты (ISO 4217) (переопределяет code из BaseReference)
- `symbol` (CharField, max_length=10) - Символ валюты

**Требования:**
- Код валюты должен быть уникальным
- По умолчанию валюта активна

---

#### 3.2.2. CashRegister (Касса)
**Назначение:** Справочник касс

**Наследует:** BaseReference

**Дополнительные поля:**
- (используются поля из BaseReference: name, description, is_active)

**Методы:**
- `get_balance(currency, date=None)` - Получить остаток по кассе в указанной валюте на определенную дату (использует регистр накоплений)

**Требования:**
- Должна быть возможность расчета остатков по каждой валюте
- Остатки рассчитываются на основе операций из регистра операций (Transaction)

---

#### 3.2.3. IncomeExpenseItem (Статья доходов/расходов)
**Назначение:** Справочник статей доходов и расходов

**Наследует:** BaseReference

**Дополнительные поля:**
- `type` (CharField, choices=['income', 'expense']) - Тип: Доход/Расход
- `parent` (ForeignKey, self, null=True, blank=True) - Родительская статья (для иерархии)

**Требования:**
- Поддержка иерархической структуры (родитель-потомок)
- Разделение на доходы и расходы

---

#### 3.2.4. Employee (Сотрудник)
**Назначение:** Справочник сотрудников

**Наследует:** BaseReference

**Дополнительные поля:**
- `first_name` (CharField, max_length=100) - Имя
- `last_name` (CharField, max_length=100) - Фамилия
- `middle_name` (CharField, max_length=100, blank=True) - Отчество
- `position` (CharField, max_length=200, blank=True) - Должность

**Методы:**
- `full_name` (property) - Полное имя сотрудника (формируется из first_name, last_name, middle_name)
- `get_advance_balance(currency)` - Получить остаток подотчетных средств в указанной валюте (использует регистр накоплений)

**Автоматическое заполнение наименования:**
- Поле `name` (наименование) может быть введено вручную пользователем
- Если поле `name` не заполнено пользователем, оно автоматически заполняется полным ФИО сотрудника
- Формат автоматически заполненного наименования: "Фамилия Имя Отчество" (отчество добавляется, если указано)
- Если пользователь указал свое наименование, оно сохраняется и используется вместо автоматически сгенерированного
- В форме редактирования поле `name` помечено как необязательное с подсказкой: "Если не указано, будет автоматически заполнено полным ФИО (Фамилия Имя Отчество)"

---

#### 3.2.5. CurrencyRate (Курс валют)
**Назначение:** Справочник курсов валют с историей

**Наследует:** BaseReference

**Дополнительные поля:**
- `from_currency` (ForeignKey, Currency) - Исходная валюта
- `to_currency` (ForeignKey, Currency) - Целевая валюта
- `rate` (DecimalField, max_digits=15, decimal_places=4) - Курс обмена (точность до десятитысячных, 4 знака после запятой)
- `date` (DateField) - Дата действия курса
- `is_active` (BooleanField, default=True) - Активен

**Требования:**
- Курс валют хранится с историей (по датам)
- Для каждой пары валют может быть несколько курсов с разными датами
- При поиске курса используется курс на указанную дату или ближайшую предыдущую дату
- Курс должен быть положительным
- Курс валюты хранится с точностью до десятитысячных (4 знака после запятой)

**Автоматическое заполнение наименования:**
- Поле `name` (наименование) может быть введено вручную пользователем
- Если поле `name` не заполнено пользователем, оно автоматически заполняется на основе кодов валют и курса
- Формат автоматически заполненного наименования: "КОД_ИСХОДНОЙ_ВАЛЮТЫ - КУРС - КОД_ЦЕЛЕВОЙ_ВАЛЮТЫ" (например, "USD - 75.12 - RUB")
- Курс в наименовании округляется до сотых (2 знака после запятой) для удобства отображения
- Если пользователь указал свое наименование, оно сохраняется и используется вместо автоматически сгенерированного
- В форме редактирования поле `name` помечено как необязательное

**Интерфейс формы редактирования:**
- В полях выбора валют (`from_currency` и `to_currency`) отображается только код валюты (например, "USD", "RUB"), а не полное наименование или ID
- Добавлены подсказки для полей:
  - **Исходная валюта:** "Валюта, из которой происходит конвертация (1 единица)"
  - **Целевая валюта:** "Валюта, в которую происходит конвертация"
  - **Курс обмена:** "Курс показывает, сколько единиц целевой валюты можно получить за 1 единицу исходной валюты. Например: если исходная валюта USD, целевая RUB, курс 75.1234, то за 1 USD можно получить 75.1234 RUB."

**Методы:**
- `get_rate(from_currency, to_currency, date)` - Получить курс обмена для пары валют на указанную дату (класс-метод или статический метод)

**Индексы:**
- По полям: from_currency, to_currency, date (для быстрого поиска курса на дату)
- Уникальность: (from_currency, to_currency, date) - один курс на пару валют на дату

---

### 3.3. Документы

Все документы наследуются от `BaseDocument` и дополняют базовую модель специфичными полями и бизнес-логикой.

**Примечание:** Все документы, наследующиеся от `BaseDocument`, автоматически получают UUID (GUID) в качестве первичного ключа.

#### 3.3.1. AdvancePayment (Выдача денег подотчетному лицу)
**Назначение:** Документ выдачи подотчетных денег сотруднику

**Наследует:** BaseDocument

**Дополнительные поля (к полям BaseDocument):**
- `employee` (ForeignKey, Employee) - Сотрудник
- `cash_register` (ForeignKey, CashRegister) - Касса
- `amount` (DecimalField, max_digits=15, decimal_places=2) - Сумма выдачи
- `currency` (ForeignKey, Currency) - Валюта
- `expense_item` (ForeignKey, IncomeExpenseItem) - Статья расходов, по которой выдаются подотчетные средства
- `purpose` (TextField) - Цель выдачи
- `is_closed` (BooleanField, default=False) - Закрыто
- `closed_at` (DateTimeField, null=True, blank=True) - Дата закрытия

**Примечание:** Дата выдачи хранится в поле `date` базовой модели BaseDocument

**Методы:**
- `close()` - Закрыть подотчетные средства
- `get_unreported_balance()` - Получить остаток неотчитанных средств

**Бизнес-логика:**
- При создании документа автоматически создается операция (Transaction) с отрицательной суммой (расход из кассы)
- Операция привязывается к документу через ForeignKey
- При редактировании документа операция обновляется, а не создается заново
- При создании операции поле `is_posted` устанавливается в `true` (документ отразился в учете)

---

#### 3.3.2. AdvanceReport (Авансовый отчет)
**Назначение:** Документ авансового отчета сотрудника по фактическим тратам

**Наследует:** BaseDocument

**Дополнительные поля (к полям BaseDocument):**
- `advance_payment` (ForeignKey, AdvancePayment) - Подотчетные средства
- `total_amount` (DecimalField) - Общая сумма расходов
- `return_amount` (DecimalField, default=0.00) - Сумма возврата (автоматически рассчитывается)
- `additional_payment` (DecimalField, default=0.00) - Сумма доплаты (автоматически рассчитывается)
- `currency` (ForeignKey, Currency) - Валюта
- `close_advance_payment` (BooleanField, default=True) - Закрыть подотчетные средства
- `manual_return_amount` (DecimalField, default=0.00) - Возврат денег (ручной)
- `manual_additional_payment` (DecimalField, default=0.00) - Дополнительная выдача (ручная)
- `status` (CharField, choices) - Статус: Черновик, Сдан, Подтвержден, Отклонен
- `approved_at` (DateTimeField, null=True, blank=True) - Дата подтверждения
- `approved_by` (ForeignKey, User, null=True, blank=True) - Подтверждено пользователем

**Методы:**
- `calculate_return_and_additional()` - Рассчитать сумму возврата и доплаты
- `approve(user)` - Подтвердить авансовый отчет

**Бизнес-логика:**
- Каждый документ выдачи денег (AdvancePayment) может быть закрыт одним или несколькими авансовыми отчетами
- При подтверждении отчета (status='confirmed'):
  - Создаются операции построчно по каждой строке отчета (AdvanceReportItem)
  - Создается операция возврата (если есть возврат)
  - Создается операция доплаты (если есть доплата)
  - Если `close_advance_payment=True`, подотчетные средства закрываются
  - Если `close_advance_payment=False` и есть доплата, создается новая выдача подотчетных средств
- **Только подтвержденные отчеты (status='confirmed') отражаются в движениях по остаткам**
- При редактировании подтвержденного отчета операции обновляются
- Общая сумма (`total_amount`) автоматически рассчитывается из суммы всех строк, если не заполнена
- Используются ручные суммы возврата/доплаты, если они указаны (отличны от 0)

---

#### 3.3.3. AdvanceReportItem (Строка авансового отчета)
**Назначение:** Строка авансового отчета с детализацией расходов

**Поля:**
- `report` (ForeignKey, AdvanceReport) - Авансовый отчет
- `item` (ForeignKey, IncomeExpenseItem) - Статья расходов
- `amount` (DecimalField) - Сумма
- `description` (TextField) - Описание (однострочное поле)
- `date` (DateTimeField) - Дата расхода
- `transaction` (OneToOneField, Transaction, null=True, blank=True) - Операция

**Требования:**
- Поле description должно быть однострочным в форме редактирования

---

#### 3.3.4. AdvanceReturn (Возврат денег сотрудником)
**Назначение:** Отдельный документ возврата денег сотрудником (полный или частичный возврат от выдачи)

**Наследует:** BaseDocument

**Дополнительные поля (к полям BaseDocument):**
- `advance_payment` (ForeignKey, AdvancePayment) - Выдача подотчетных средств, к которой относится возврат
- `employee` (ForeignKey, Employee) - Сотрудник
- `cash_register` (ForeignKey, CashRegister) - Касса
- `amount` (DecimalField, max_digits=15, decimal_places=2) - Сумма возврата
- `currency` (ForeignKey, Currency) - Валюта
- `description` (TextField, blank=True) - Описание возврата

**Примечание:** Дата возврата хранится в поле `date` базовой модели BaseDocument

**Бизнес-логика:**
- При создании документа автоматически создается операция (Transaction) с положительной суммой (поступление в кассу)
- Операция привязывается к документу через ForeignKey
- При редактировании документа операция обновляется, а не создается заново
- При создании операции поле `is_posted` устанавливается в `true` (документ отразился в учете)
- Возврат влияет на расчет остатков подотчетных средств
- Возможен полный или частичный возврат от первоначальной выдачи

**Валидация:**
- **Валидация суммы возврата:** Сумма возврата не может превышать сумму выданных подотчетных средств с учетом всех дополнительных выдач (AdvancePayment + AdditionalAdvancePayment) за вычетом уже возвращенных сумм (существующие возвраты и возвраты по авансовым отчетам). При превышении система должна блокировать сохранение документа с сообщением об ошибке.
- **Проверка на отрицательные суммы:** Сумма возврата должна быть положительной. Система должна блокировать сохранение документа при отрицательной или нулевой сумме.

---

#### 3.3.5. AdditionalAdvancePayment (Дополнительная выдача подотчетных средств)
**Назначение:** Документ дополнительной выдачи подотчетных средств, привязанный к первоначальной выдаче

**Наследует:** BaseDocument

**Дополнительные поля (к полям BaseDocument):**
- `original_advance_payment` (ForeignKey, AdvancePayment) - Первоначальная выдача подотчетных средств
- `cash_register` (ForeignKey, CashRegister) - Касса
- `amount` (DecimalField, max_digits=15, decimal_places=2) - Сумма дополнительной выдачи
- `currency` (ForeignKey, Currency) - Валюта
- `purpose` (TextField) - Цель дополнительной выдачи

**Примечание:** 
- Дата выдачи хранится в поле `date` базовой модели BaseDocument
- Сотрудник берется из первоначальной выдачи (`original_advance_payment.employee`), поэтому отдельное поле `employee` не требуется

**Бизнес-логика:**
- При создании документа автоматически создается операция (Transaction) с отрицательной суммой (расход из кассы)
- Операция привязывается к документу через ForeignKey
- При создании операции сотрудник берется из первоначальной выдачи (`original_advance_payment.employee`)
- При редактировании документа операция обновляется, а не создается заново
- При создании операции поле `is_posted` устанавливается в `true` (документ отразился в учете)
- Дополнительная выдача влияет на расчет остатков подотчетных средств

**Валидация:**
- **Проверка на отрицательные суммы:** Сумма дополнительной выдачи должна быть положительной. Система должна блокировать сохранение документа при отрицательной или нулевой сумме.

---

### 3.4. Документы операций

Все документы операций наследуются от `BaseDocument`.

#### 3.4.1. IncomeDocument (Оприходование денег)
**Назначение:** Документ оприходования денежных средств в кассу

**Наследует:** BaseDocument

**Дополнительные поля (к полям BaseDocument):**
- `cash_register` (ForeignKey, CashRegister) - Касса
- `currency` (ForeignKey, Currency) - Валюта
- `amount` (DecimalField) - Сумма оприходования
- `item` (ForeignKey, IncomeExpenseItem) - Статья доходов
- `description` (TextField, blank=True) - Описание
- `employee` (ForeignKey, Employee, null=True, blank=True) - Сотрудник (если применимо)

**Бизнес-логика:**
- При создании документа автоматически создается операция (Transaction) с положительной суммой (поступление в кассу)
- Операция привязывается к документу через ForeignKey
- При редактировании документа операция обновляется, а не создается заново
- При создании операции поле `is_posted` устанавливается в `true` (документ отразился в учете)

---

#### 3.4.2. ExpenseDocument (Расход денег)
**Назначение:** Документ расхода денежных средств из кассы

**Наследует:** BaseDocument

**Дополнительные поля (к полям BaseDocument):**
- `cash_register` (ForeignKey, CashRegister) - Касса
- `currency` (ForeignKey, Currency) - Валюта
- `amount` (DecimalField) - Сумма расхода
- `item` (ForeignKey, IncomeExpenseItem) - Статья расходов
- `description` (TextField, blank=True) - Описание
- `employee` (ForeignKey, Employee, null=True, blank=True) - Сотрудник (если применимо)

**Бизнес-логика:**
- При создании документа автоматически создается операция (Transaction) с отрицательной суммой (расход из кассы)
- Операция привязывается к документу через ForeignKey
- При редактировании документа операция обновляется, а не создается заново
- При создании операции поле `is_posted` устанавливается в `true` (документ отразился в учете)

---

### 3.5. Журнал операций

#### 3.5.1. Transaction (Операция / Журнал операций)
**Назначение:** Общий журнал операций со ссылками на документы, физические лица, валюты, статьи расходов и доходов

**Наследует:** BaseOperationRegister

**Дополнительные поля (к полям BaseOperationRegister):**
- `transaction_type` (CharField, choices) - Тип операции:
  - 'income' - Оприходование денег
  - 'expense' - Расход денег
  - 'advance_payment' - Выдача подотчетных
  - 'advance_report' - Авансовый отчет (строка отчета)
  - 'advance_return' - Возврат денег сотрудником (отдельный документ возврата)
  - 'advance_return_report' - Возврат денег по авансовому отчету (в рамках авансового отчета)
  - 'additional_advance_payment' - Дополнительная выдача подотчетных средств
  - 'advance_additional' - Доплата по авансовому отчету
  - 'transfer' - Перемещение между кассами
  - 'conversion' - Конвертация валют
- `cash_register` (ForeignKey, CashRegister) - Касса
- `currency` (ForeignKey, Currency) - Валюта
- `item` (ForeignKey, IncomeExpenseItem, null=True, blank=True) - Статья доходов/расходов
- `employee` (ForeignKey, Employee, null=True, blank=True) - Физическое лицо (сотрудник)
- `income_document` (ForeignKey, IncomeDocument, null=True, blank=True) - Документ оприходования
- `expense_document` (ForeignKey, ExpenseDocument, null=True, blank=True) - Документ расхода
- `advance_payment` (ForeignKey, AdvancePayment, null=True, blank=True) - Выдача подотчетных средств
- `advance_report` (ForeignKey, AdvanceReport, null=True, blank=True) - Авансовый отчет
- `advance_report_item` (ForeignKey, AdvanceReportItem, null=True, blank=True) - Строка авансового отчета
- `advance_return` (ForeignKey, AdvanceReturn, null=True, blank=True) - Возврат денег сотрудником (отдельный документ)
- `additional_advance_payment` (ForeignKey, AdditionalAdvancePayment, null=True, blank=True) - Дополнительная выдача подотчетных средств
- `cash_transfer` (ForeignKey, CashTransfer, null=True, blank=True) - Перемещение между кассами
- `currency_conversion` (ForeignKey, CurrencyConversion, null=True, blank=True) - Конвертация валют

**Требования:**
- Наследует все поля и поведение от BaseOperationRegister
- Операции привязываются к документам, а не наоборот
- Несколько операций могут быть привязаны к одному документу
- Дата операции устанавливается по дате документа
- Сумма может быть положительной (поступление) или отрицательной (расход)
- Операции из подтвержденных авансовых отчетов отражаются в движениях по остаткам
- Используется для расчета остатков в регистре накоплений

**Индексы:**
- По полям: date, cash_register, currency
- По полям: transaction_type, date
- По полям: employee, date

---

#### 3.5.2. CashTransfer (Перемещение между кассами)
**Назначение:** Документ перемещения денежных средств между кассами

**Наследует:** BaseDocument

**Дополнительные поля (к полям BaseDocument):**
- `from_cash_register` (ForeignKey, CashRegister) - Из кассы
- `to_cash_register` (ForeignKey, CashRegister) - В кассу
- `currency` (ForeignKey, Currency) - Валюта
- `amount` (DecimalField) - Сумма

**Бизнес-логика:**
- При создании документа создаются две операции:
  - Операция списания из исходной кассы (отрицательная сумма)
  - Операция поступления в целевую кассу (положительная сумма)
- При создании операций поле `is_posted` устанавливается в `true` (документ отразился в учете)

**Валидация:**
- **Проверка совпадения касс:** Исходная касса (`from_cash_register`) и целевая касса (`to_cash_register`) не должны совпадать. Система должна блокировать сохранение документа с сообщением об ошибке при совпадении касс.
- **Проверка наличия достаточного остатка:** В исходной кассе (`from_cash_register`) должен быть достаточный остаток в указанной валюте на дату документа. Остаток рассчитывается на дату документа (включительно). Если остаток недостаточен, система должна блокировать сохранение документа с сообщением об ошибке.
- **Проверка на отрицательные суммы:** Сумма перемещения должна быть положительной. Система должна блокировать сохранение документа при отрицательной или нулевой сумме.

---

#### 3.5.3. CurrencyConversion (Конвертация валют)
**Назначение:** Документ конвертации валют

**Наследует:** BaseDocument

**Дополнительные поля (к полям BaseDocument):**
- `from_currency` (ForeignKey, Currency) - Из валюты
- `to_currency` (ForeignKey, Currency) - В валюту
- `cash_register` (ForeignKey, CashRegister) - Касса
- `from_amount` (DecimalField) - Сумма в исходной валюте
- `to_amount` (DecimalField) - Сумма в целевой валюте
- `exchange_rate` (DecimalField) - Курс обмена

**Бизнес-логика:**
- При создании документа создаются две операции:
  - Операция списания исходной валюты (отрицательная сумма)
  - Операция поступления целевой валюты (положительная сумма)
- При создании операций поле `is_posted` устанавливается в `true` (документ отразился в учете)
- **Автоматическое заполнение курса обмена:** При создании или редактировании документа, если поле `exchange_rate` пустое или не заполнено, система автоматически ищет курс валют в справочнике `CurrencyRate` для пары валют (`from_currency`, `to_currency`) на дату документа. Если курс найден, он автоматически заполняется в поле `exchange_rate`. Если курс не найден, пользователь должен ввести его вручную.
- **Автоматический расчет суммы в целевой валюте:** При изменении `from_amount` или `exchange_rate` система автоматически рассчитывает `to_amount = from_amount * exchange_rate` (с учетом округления до 2 знаков после запятой). Пользователь может вручную скорректировать `to_amount`, если необходимо.

**Валидация:**
- **Проверка совпадения валют:** Исходная валюта (`from_currency`) и целевая валюта (`to_currency`) не должны совпадать. Система должна блокировать сохранение документа с сообщением об ошибке при совпадении валют.
- **Проверка наличия достаточного остатка:** В кассе (`cash_register`) должен быть достаточный остаток исходной валюты (`from_currency`) на дату документа. Остаток рассчитывается на дату документа (включительно). Если остаток недостаточен, система должна блокировать сохранение документа с сообщением об ошибке.
- **Проверка на положительный курс обмена:** Курс обмена (`exchange_rate`) должен быть положительным. Система должна блокировать сохранение документа при отрицательном или нулевом курсе.
- **Валидация соответствия курса и сумм:** Сумма в целевой валюте (`to_amount`) должна соответствовать расчету: `to_amount = from_amount * exchange_rate` (с учетом округления до 2 знаков после запятой). Допускается отклонение не более чем на 0.01 (округление). Если отклонение больше, система должна предупредить пользователя или заблокировать сохранение документа.
- **Проверка на отрицательные суммы:** Все суммы (`from_amount`, `to_amount`) должны быть положительными. Система должна блокировать сохранение документа при отрицательных или нулевых суммах.

---

## 4. Интерфейс пользователя

### 4.1. Django Admin

#### 4.1.1. Общие требования
- Интерфейс на русском языке
- Все модели зарегистрированы в админке
- Поддержка фильтров и поиска
- Использование `raw_id_fields` для оптимизации при большом количестве записей
- Использование `autocomplete_fields` где необходимо

#### 4.1.2. Справочники
- **Currency:** Фильтр по активности, поиск по коду и названию
- **CashRegister:** Отображение остатков по валютам в списке, фильтр по активности
- **IncomeExpenseItem:** Фильтр по типу и активности, поддержка иерархии
- **Employee:** Фильтр по активности, поиск по ФИО и должности
- **CurrencyRate (Курс валют):** Фильтр по исходной и целевой валютам, по дате, по активности. Поиск по валютам. Отображение курса и даты действия. Возможность массового импорта курсов валют (опционально)

#### 4.1.3. Документы
- **IncomeDocument (Оприходование денег):**
  - Фильтр по кассе, валюте, статье доходов, сотруднику
  - Автоматическое создание/обновление операции при сохранении
  
- **ExpenseDocument (Расход денег):**
  - Фильтр по кассе, валюте, статье расходов, сотруднику
  - Автоматическое создание/обновление операции при сохранении

- **AdvancePayment (Выдача денег подотчетному лицу):**
  - Отображение остатка неотчитанных средств в списке
  - Фильтр по сотруднику, валюте, статье расходов, статусу закрытия
  - Автоматическое создание/обновление операции при сохранении
  
- **AdvanceReport:**
  - Отображение сумм возврата и доплаты в списке
  - Фильтр по сотруднику, статусу, валюте
  - Inline-редактирование строк отчета
  - Поле description в строках - однострочное
  - Автоматический расчет общей суммы из строк
  - Поля для управления закрытием подотчетных средств и ручного указания сумм
  - **Только подтвержденные отчеты отражаются в движениях по остаткам**
  - **Примечание:** Массовое подтверждение авансовых отчетов не предусмотрено. Каждый отчет подтверждается индивидуально.

- **AdvanceReturn (Возврат денег сотрудником):**
  - Фильтр по сотруднику, валюте, связанной выдаче
  - Автоматическое создание/обновление операции при сохранении
  - Отображение связи с первоначальной выдачей

- **AdditionalAdvancePayment (Дополнительная выдача подотчетных средств):**
  - Фильтр по валюте, связанной первоначальной выдаче (сотрудник определяется через первоначальную выдачу)
  - Автоматическое создание/обновление операции при сохранении
  - Отображение связи с первоначальной выдачей
  - Отображение сотрудника из первоначальной выдачи (только для просмотра, не редактируется)

- **CashTransfer (Перемещение между кассами):**
  - Фильтр по исходной и целевой кассам, валюте, дате
  - Автоматическое создание/обновление операций при сохранении
  - Валидация совпадения касс и наличия достаточного остатка

- **CurrencyConversion (Конвертация валют):**
  - Фильтр по исходной и целевой валютам, кассе, дате
  - Автоматическое заполнение курса обмена из справочника CurrencyRate при создании/редактировании
  - Автоматический расчет суммы в целевой валюте при изменении суммы в исходной валюте или курса
  - Автоматическое создание/обновление операций при сохранении
  - Валидация совпадения валют, наличия достаточного остатка, соответствия курса и сумм

- **Transaction (Журнал операций):**
  - Отображение всех связей с документами (income_document, expense_document, advance_payment, advance_report, advance_return, additional_advance_payment, cash_transfer, currency_conversion)
  - Отображение физического лица (employee)
  - Отображение валюты и статьи доходов/расходов
  - Фильтры по типу, валюте, кассе, дате, сотруднику, статье
  - Иерархия дат для навигации
  - Поиск по описанию

---

## 5. Бизнес-логика

### 5.1. Выдача денег подотчетному лицу

**Процесс:**
1. Создается документ AdvancePayment с указанием сотрудника, кассы, суммы, валюты, статьи расходов и цели выдачи
2. Автоматически создается операция Transaction:
   - Тип: 'advance_payment'
   - Сумма: отрицательная (расход из кассы)
   - Дата: дата документа (date_issued)
   - Привязка к документу через ForeignKey
3. При редактировании документа операция обновляется, а не создается заново
4. При создании операции поле `is_posted` устанавливается в `true` (документ отразился в учете)

---

### 5.2. Авансовый отчет

**Процесс подтверждения:**
1. При установке статуса 'confirmed' (Подтвержден):
   - Рассчитываются суммы возврата и доплаты
   - Создаются операции по каждой строке отчета (построчно) - только для подтвержденных отчетов
   - Создается операция возврата (если есть возврат)
   - Создается операция доплаты (если есть доплата)
   - Если `close_advance_payment=True`, подотчетные средства закрываются
   - Если `close_advance_payment=False` и есть доплата, создается новая выдача подотчетных средств
   - **Операции отражаются в движениях по остаткам**
   - При создании операций поле `is_posted` устанавливается в `true` (документ отразился в учете)

2. При редактировании подтвержденного отчета:
   - Операции по строкам обновляются
   - Операции возврата/доплаты обновляются
   - Удаляются операции для удаленных строк

3. При изменении статуса с 'confirmed' на другой:
   - Все операции, созданные при подтверждении отчета, полностью удаляются из журнала операций
   - Это включает операции по строкам отчета, операции возврата и операции доплаты
   - При удалении операций поле `is_posted` устанавливается в `false` (документ не отражается в учете)
   - При повторном подтверждении отчета операции создаются заново, и поле `is_posted` снова устанавливается в `true`

**Расчет сумм:**
- Общая сумма (`total_amount`) автоматически рассчитывается из суммы всех строк, если не заполнена
- Сумма возврата (`return_amount`) = выданная сумма - общая сумма расходов (если расходы меньше)
- Сумма доплаты (`additional_payment`) = общая сумма расходов - выданная сумма (если расходы больше)
- Используются ручные суммы (`manual_return_amount`, `manual_additional_payment`), если они указаны

**Валидация сумм:**
- **Валидация суммы возврата:** Сумма возврата (включая ручную `manual_return_amount`) не может превышать сумму выданных подотчетных средств с учетом всех дополнительных выдач (AdvancePayment + AdditionalAdvancePayment). При превышении система должна блокировать сохранение отчета с сообщением об ошибке.
- **Валидация суммы доплаты:** Сумма доплаты (включая ручную `manual_additional_payment`) должна быть обоснована превышением общей суммы расходов над суммой выданных подотчетных средств. Если доплата указана, но расходы не превышают выданную сумму, система должна предупредить пользователя или заблокировать сохранение.
- **Проверка на отрицательные суммы:** Все суммы (общая сумма расходов, сумма возврата, сумма доплаты, суммы в строках отчета) должны быть неотрицательными. Система должна блокировать сохранение отчета при наличии отрицательных сумм.

**Закрытие выдачи подотчетных средств:**
- Каждый документ выдачи денег (AdvancePayment) может быть закрыт одним или несколькими авансовыми отчетами
- Выдача считается закрытой, когда сумма всех подтвержденных отчетов по ней равна сумме выдачи (с учетом возвратов и доплат)
- При расчете остатков учитываются также отдельные документы возврата (AdvanceReturn) и дополнительные выдачи (AdditionalAdvancePayment)

---

**Требование:** При закрытии (подтверждении) сотрудником ранее выданных подотчетных средств в авансовом отчете, строки отчета должны использовать строго ту же статью расходов, по которой была произведена первоначальная выдача денег.

**Реализация:**
- При создании строк авансового отчета система должна проверять соответствие статей расходов в строках отчета (AdvanceReportItem.item) статье расходов, указанной при выдаче подотчетных средств (AdvancePayment.expense_item)
- Валидация должна выполняться на уровне формы и модели при сохранении авансового отчета
- Если в строке отчета указана статья расходов, отличная от статьи расходов при выдаче, система должна заблокировать сохранение отчета до исправления статьи расходов
- Валидация является обязательной и не может быть отключена

---

### 5.3. Возврат денег сотрудником (отдельный документ)

**Процесс:**
1. Создается документ AdvanceReturn с привязкой к выданным подотчетным средствам (AdvancePayment)
2. Указывается сумма возврата (полный или частичный возврат от первоначальной выдачи)
3. Автоматически создается операция Transaction:
   - Тип: 'advance_return'
   - Сумма: положительная (поступление в кассу)
   - Дата: дата документа
   - Привязка к документу через ForeignKey
4. При редактировании документа операция обновляется, а не создается заново
5. Возврат влияет на расчет остатков подотчетных средств
6. При создании операции поле `is_posted` устанавливается в `true` (документ отразился в учете)

**Особенности:**
- Возможен полный или частичный возврат от первоначальной выдачи
- Возврат может быть создан независимо от авансового отчета
- Возврат учитывается при расчете остатков подотчетных средств

**Валидация:**
- **Валидация суммы возврата:** Сумма возврата не может превышать сумму выданных подотчетных средств с учетом всех дополнительных выдач (AdvancePayment + AdditionalAdvancePayment) за вычетом уже возвращенных сумм (существующие возвраты и возвраты по авансовым отчетам). При превышении система должна блокировать сохранение документа с сообщением об ошибке.
- **Проверка на отрицательные суммы:** Сумма возврата должна быть положительной. Система должна блокировать сохранение документа при отрицательной или нулевой сумме.

---

### 5.4. Дополнительная выдача подотчетных средств

**Процесс:**
1. Создается документ AdditionalAdvancePayment с привязкой к первоначальной выдаче (AdvancePayment)
2. Указывается сумма дополнительной выдачи, цель выдачи
3. Автоматически создается операция Transaction:
   - Тип: 'additional_advance_payment'
   - Сумма: отрицательная (расход из кассы)
   - Дата: дата документа
   - Привязка к документу через ForeignKey
4. При редактировании документа операция обновляется, а не создается заново
5. Дополнительная выдача влияет на расчет остатков подотчетных средств
6. При создании операции поле `is_posted` устанавливается в `true` (документ отразился в учете)

**Особенности:**
- Дополнительная выдача привязана к первоначальной выдаче
- Дополнительная выдача учитывается при расчете остатков подотчетных средств

**Валидация:**
- **Проверка на отрицательные суммы:** Сумма дополнительной выдачи должна быть положительной. Система должна блокировать сохранение документа при отрицательной или нулевой сумме.

---

### 5.5. Расчет остатков

**Остатки по кассам:**
- Рассчитываются на основе всех операций (Transaction) по кассе и валюте
- Поддерживается расчет на определенную дату
- Метод: `CashRegister.get_balance(currency, date=None)`
- Остатки хранятся в системе и рассчитываются динамически на основе операций

**Остатки по выданным авансам сотрудникам:**
- Рассчитываются на основе:
  - Выданных сумм (AdvancePayment + AdditionalAdvancePayment)
  - Минус суммы подтвержденных отчетов (AdvanceReport)
  - Минус суммы возвратов (AdvanceReturn + возвраты по авансовым отчетам)
  - Плюс суммы доплат (доплаты по авансовым отчетам)
- Метод: `Employee.get_advance_balance(currency)` - остаток по сотруднику в указанной валюте
- Метод: `AdvancePayment.get_unreported_balance()` - остаток неотчитанных средств по конкретной выдаче (с учетом дополнительных выдач, возвратов и доплат)
- Остатки хранятся в системе и рассчитываются динамически на основе операций
- **Учитываются только операции из подтвержденных авансовых отчетов**
- **Учитываются все операции возврата (отдельные документы и возвраты по авансовым отчетам)**
- **Учитываются все дополнительные выдачи подотчетных средств**

---

### 5.6. Перемещение между кассами (CashTransfer)

**Процесс:**
1. Создается документ CashTransfer с указанием исходной кассы, целевой кассы, валюты и суммы
2. Выполняется валидация:
   - Проверка, что исходная и целевая кассы не совпадают
   - Проверка наличия достаточного остатка в исходной кассе на дату документа
   - Проверка на положительную сумму
3. Автоматически создаются две операции Transaction:
   - Операция списания из исходной кассы (отрицательная сумма, тип: 'transfer')
   - Операция поступления в целевую кассу (положительная сумма, тип: 'transfer')
   - Дата: дата документа
   - Привязка к документу через ForeignKey
4. При редактировании документа операции обновляются, а не создаются заново
5. При создании операций поле `is_posted` устанавливается в `true` (документ отразился в учете)

**Валидация:**
- **Проверка совпадения касс:** Исходная касса и целевая касса не должны совпадать. Система должна блокировать сохранение документа с сообщением об ошибке при совпадении касс.
- **Проверка наличия достаточного остатка:** В исходной кассе должен быть достаточный остаток в указанной валюте на дату документа. Остаток рассчитывается на дату документа (включительно). Если остаток недостаточен, система должна блокировать сохранение документа с сообщением об ошибке.
- **Проверка на отрицательные суммы:** Сумма перемещения должна быть положительной. Система должна блокировать сохранение документа при отрицательной или нулевой сумме.

---

### 5.7. Конвертация валют (CurrencyConversion)

**Процесс:**
1. Создается документ CurrencyConversion с указанием исходной валюты, целевой валюты, кассы, суммы в исходной валюте
2. Автоматическое заполнение курса обмена:
   - Система ищет курс валют в справочнике `CurrencyRate` для пары валют (`from_currency`, `to_currency`) на дату документа
   - Если курс найден, он автоматически заполняется в поле `exchange_rate`
   - Если курс не найден, пользователь должен ввести его вручную
3. Автоматический расчет суммы в целевой валюте:
   - При изменении `from_amount` или `exchange_rate` система автоматически рассчитывает `to_amount = from_amount * exchange_rate` (с учетом округления до 2 знаков после запятой)
   - Пользователь может вручную скорректировать `to_amount`, если необходимо
4. Выполняется валидация:
   - Проверка, что исходная и целевая валюты не совпадают
   - Проверка наличия достаточного остатка исходной валюты в кассе на дату документа
   - Проверка на положительный курс обмена
   - Валидация соответствия курса и сумм: `to_amount = from_amount * exchange_rate` (с учетом округления)
   - Проверка на положительные суммы
5. Автоматически создаются две операции Transaction:
   - Операция списания исходной валюты (отрицательная сумма, тип: 'conversion')
   - Операция поступления целевой валюты (положительная сумма, тип: 'conversion')
   - Дата: дата документа
   - Привязка к документу через ForeignKey
6. При редактировании документа операции обновляются, а не создаются заново
7. При создании операций поле `is_posted` устанавливается в `true` (документ отразился в учете)

**Валидация:**
- **Проверка совпадения валют:** Исходная валюта и целевая валюта не должны совпадать. Система должна блокировать сохранение документа с сообщением об ошибке при совпадении валют.
- **Проверка наличия достаточного остатка:** В кассе должен быть достаточный остаток исходной валюты на дату документа. Остаток рассчитывается на дату документа (включительно). Если остаток недостаточен, система должна блокировать сохранение документа с сообщением об ошибке.
- **Проверка на положительный курс обмена:** Курс обмена должен быть положительным. Система должна блокировать сохранение документа при отрицательном или нулевом курсе.
- **Валидация соответствия курса и сумм:** Сумма в целевой валюте должна соответствовать расчету: `to_amount = from_amount * exchange_rate` (с учетом округления до 2 знаков после запятой). Допускается отклонение не более чем на 0.01 (округление). Если отклонение больше, система должна предупредить пользователя или заблокировать сохранение документа.
- **Проверка на отрицательные суммы:** Все суммы должны быть положительными. Система должна блокировать сохранение документа при отрицательных или нулевых суммах.

---

## 6. Отчеты

Система должна обеспечивать формирование отчетности для анализа финансового состояния и движения денежных средств. Все отчеты формируются на основе данных из регистра операций и регистра накоплений.

### 6.0. Экспорт и печать отчетов

**Требования к экспорту отчетов:**

Все отчеты системы должны поддерживать экспорт в следующих форматах:

1. **Экспорт в формат XLSX (Excel):**
   - Все отчеты должны иметь возможность экспорта в формат XLSX
   - Экспортированный файл должен сохранять структуру и форматирование отчета
   - Должны быть сохранены все данные отчета, включая заголовки, итоги и группировки
   - Форматирование должно включать:
     - Заголовки отчетов (название, период, параметры)
     - Заголовки столбцов
     - Форматирование чисел (денежные суммы с разделителями разрядов)
     - Итоговые строки
     - Группировки (если применимо)
   - Имя файла должно содержать название отчета и дату/время экспорта
   - Формат имени файла: `НазваниеОтчета_YYYY-MM-DD_HH-MM-SS.xlsx`

2. **Печатный формат (PDF или печать на принтер):**
   - Все отчеты должны иметь возможность вывода в печатный формат
   - Печатный формат должен быть оптимизирован для печати на стандартных форматах бумаги (A4)
   - Должны быть предусмотрены:
     - Заголовок отчета с названием и параметрами
     - Колонтитулы с датой формирования и номером страницы
     - Разбивка на страницы с переносом данных
     - Сохранение структуры и форматирования отчета
   - Должна быть возможность предварительного просмотра перед печатью
   - Печатный формат может быть реализован через:
     - Генерацию PDF-файла
     - Прямую печать на принтер через браузер
     - Сохранение в PDF для последующей печати

**Интерфейс экспорта:**
- Кнопки экспорта должны быть доступны на странице каждого отчета
- Кнопка "Экспорт в XLSX" - для экспорта в Excel
- Кнопка "Печать" или "Экспорт в PDF" - для печатного формата
- Экспорт должен выполняться с теми же параметрами, которые были выбраны для отображения отчета
- При экспорте должен отображаться индикатор прогресса (для больших отчетов)

**Технические требования:**
- Для экспорта в XLSX рекомендуется использовать библиотеку `openpyxl` или `xlsxwriter`
- Для генерации PDF рекомендуется использовать библиотеку `reportlab` или `weasyprint`
- Для печати через браузер можно использовать стандартные возможности браузера (window.print())

---

### 6.1. Отчет о текущем состоянии остатков по кассам

**Назначение:** Просмотр текущего состояния остатков денежных средств по всем кассам и валютам на определенную дату

**Параметры отчета:**
- Дата отчета (обязательный параметр)

**Функциональность:**
- Форма выбора даты отчета
- Таблица с остатками по кассам и валютам на выбранную дату
- Структура таблицы:
  - Касса
  - Валюта
  - Остаток на дату
- Строка итогов по каждой валюте (сумма остатков по всем кассам)
- Отображение нулевых остатков
- Экспорт отчета в формат XLSX
- Вывод отчета в печатный формат (PDF или печать на принтер)

**Алгоритм расчета:**
- Остатки рассчитываются на основе всех операций (Transaction) по кассе и валюте на дату отчета
- Используется метод: `CashRegister.get_balance(currency, date=report_date)`

**URL:** `/reports/cash-balance/`

---

### 6.2. Отчет об операциях и движениях денег за период

**Назначение:** Анализ всех операций и движений денежных средств за выбранный период с отображением входящих и исходящих остатков

**Параметры отчета:**
- Дата начала периода (обязательный параметр)
- Дата окончания периода (обязательный параметр)
- Касса (опциональный параметр, для фильтрации)
- Валюта (опциональный параметр, для фильтрации)

**Функциональность:**
- Форма выбора периода (дата начала и дата окончания)
- Форма выбора кассы (опционально, для фильтрации по конкретной кассе)
- Форма выбора валюты (опционально, для фильтрации по конкретной валюте)
- Таблица с операциями за период:
  - Дата операции
  - Тип операции
  - Номер и дата документа-основания
  - Касса
  - Валюта
  - Сотрудник (если применимо)
  - Статья доходов/расходов
  - Сумма (положительная для поступлений, отрицательная для расходов)
  - Описание операции
- Входящий остаток на начало периода:
  - По каждой кассе и валюте
  - Рассчитывается на дату начала периода
- Исходящий остаток на конец периода:
  - По каждой кассе и валюте
  - Рассчитывается на дату окончания периода
- Обороты за период:
  - Приход (сумма всех положительных операций)
  - Расход (сумма всех отрицательных операций)
  - Чистый оборот (приход - расход)
- Итоги по кассам и валютам:
  - Входящий остаток
  - Приход за период
  - Расход за период
  - Исходящий остаток
- Группировка по кассам и валютам
- Экспорт отчета в формат XLSX
- Вывод отчета в печатный формат (PDF или печать на принтер)

**Алгоритм расчета:**
- Входящий остаток = сумма всех операций до даты начала периода (включительно)
- Исходящий остаток = сумма всех операций до даты окончания периода (включительно)
- Приход = сумма всех положительных операций за период
- Расход = сумма всех отрицательных операций за период
- Исходящий остаток = Входящий остаток + Приход - Расход

**URL:** `/reports/transactions-period/`

---

### 6.3. Отчет об остатках по подотчетным деньгам

**Назначение:** Анализ остатков подотчетных средств с детализацией по выдачам, отчетам, возвратам и доплатам

**Параметры отчета:**
- Дата отчета (обязательный параметр)
- Сотрудник (опциональный параметр, для фильтрации)
- Валюта (опциональный параметр, для фильтрации)

**Функциональность:**
- Форма выбора даты отчета
- Форма выбора сотрудника (опционально, для фильтрации по конкретному сотруднику)
- Форма выбора валюты (опционально, для фильтрации по конкретной валюте)
- Сводная таблица с остатками по подотчетным средствам:
  - Сотрудник
  - Валюта
  - Выданная сумма (сумма всех выдач подотчетных средств)
  - Отчитанная сумма (сумма всех подтвержденных авансовых отчетов)
  - Возвращенная сумма (сумма всех возвратов денег)
  - Доплаченная сумма (сумма всех доплат)
  - Текущий остаток (неотчитанные средства) = Выданная сумма - Отчитанная сумма + Доплаченная сумма - Возвращенная сумма
- Детализация по каждому сотруднику (раскрываемая секция):
  - **Выдачи подотчетных средств:**
    - Номер документа
    - Дата выдачи
    - Сумма
    - Валюта
    - Цель выдачи
    - Статус (открыта/закрыта)
  - **Авансовые отчеты:**
    - Номер документа
    - Дата отчета
    - Сумма расходов
    - Сумма возврата
    - Сумма доплаты
    - Статус (черновик/сдан/подтвержден/отклонен)
    - Связь с выдачей подотчетных средств
  - **Возвраты денег:**
    - Дата возврата
    - Сумма
    - Валюта
    - Тип возврата (отдельный документ возврата или возврат по авансовому отчету)
    - Связь с выдачей подотчетных средств (для отдельного документа возврата)
    - Связь с авансовым отчетом (для возврата по авансовому отчету)
  - **Доплаты:**
    - Дата доплаты
    - Сумма
    - Валюта
    - Связь с авансовым отчетом
  - **Дополнительные выдачи:**
    - Номер документа
    - Дата выдачи
    - Сумма
    - Валюта
    - Цель выдачи
    - Связь с первоначальной выдачей подотчетных средств
- Итоги по валютам:
  - Общая выданная сумма
  - Общая отчитанная сумма
  - Общая возвращенная сумма
  - Общая доплаченная сумма
  - Общий остаток
- Экспорт отчета в формат XLSX
- Вывод отчета в печатный формат (PDF или печать на принтер)

**Алгоритм расчета:**
- Выданная сумма = сумма всех документов AdvancePayment + сумма всех документов AdditionalAdvancePayment по сотруднику и валюте
- Отчитанная сумма = сумма всех подтвержденных авансовых отчетов (status='confirmed') по сотруднику и валюте
- Возвращенная сумма = сумма всех операций возврата (transaction_type='advance_return' - отдельный документ возврата, transaction_type='advance_return_report' - возврат по авансовому отчету) по сотруднику и валюте
- Доплаченная сумма = сумма всех операций доплаты (transaction_type='advance_additional') по сотруднику и валюте
- Текущий остаток = Выданная сумма - Отчитанная сумма + Доплаченная сумма - Возвращенная сумма
- Используются методы: `Employee.get_advance_balance(currency)` и `AdvancePayment.get_unreported_balance()`

**URL:** `/reports/advance-balance/`

---

### 6.4. Касса по дням

**Назначение:** Детальный отчет по операциям с подотчетными средствами, включающий выдачи, возвраты и авансовые отчеты с указанием прихода и расхода

**Параметры отчета:**
- Дата начала периода (обязательный параметр)
- Дата окончания периода (обязательный параметр)
- Сотрудник (опциональный параметр, для фильтрации)
- Валюта (опциональный параметр, для фильтрации)

**Функциональность:**
- Форма выбора периода (дата начала и дата окончания)
- Форма выбора сотрудника (опционально, для фильтрации по конкретному сотруднику)
- Форма выбора валюты (опционально, для фильтрации по конкретной валюте)
- Таблица с операциями по подотчетным средствам за период:
  - № документа выдачи / возврата / авансового отчета
  - Дата документа
  - От кого получено или кому выдано (сотрудник)
  - Приход (положительные суммы: возвраты денег, доплаты по авансовым отчетам)
  - Расход (отрицательные суммы: выдачи подотчетных средств, расходы по авансовым отчетам)
  - Основание (описание операции, цель выдачи, описание строки авансового отчета)
  - Валюта
- Итоги по приходу и расходу:
  - Общий приход за период
  - Общий расход за период
  - Чистый оборот (приход - расход)
- Группировка по сотрудникам и валютам (опционально)
- Экспорт отчета в формат XLSX
- Вывод отчета в печатный формат (PDF или печать на принтер)

**Алгоритм расчета:**
- Отчет формируется на основе операций (Transaction) с типами:
  - `advance_payment` - выдача подотчетных средств (отображается как расход)
  - `additional_advance_payment` - дополнительная выдача подотчетных средств (отображается как расход)
  - `advance_return` - возврат денег сотрудником (отдельный документ возврата, отображается как приход)
  - `advance_return_report` - возврат денег по авансовому отчету (в рамках авансового отчета, отображается как приход)
  - `advance_additional` - доплата по авансовому отчету (отображается как приход)
  - `advance_report` - строка авансового отчета (отображается как расход)
- Приход = сумма всех положительных операций по подотчетным средствам за период
- Расход = сумма всех отрицательных операций по подотчетным средствам за период (по модулю)
- Номер документа берется из связанного документа (AdvancePayment, AdditionalAdvancePayment, AdvanceReturn, AdvanceReport)
- Описание формируется из:
  - Для выдачи: поле `purpose` из документа AdvancePayment или AdditionalAdvancePayment
  - Для авансового отчета: поле `description` из строки AdvanceReportItem
  - Для возврата (отдельный документ): поле `description` из документа AdvanceReturn
  - Для возврата/доплаты по авансовому отчету: описание из операции Transaction

**URL:** `/reports/advance-operations/`

---

### 6.5. Отчет «Расход денежных средств по статьям»

**Назначение:** Анализ расходов денежных средств по статьям расходов с детализацией по расходам из авансовых отчетов и остатками неотчитанных/не возвращенных подотчетных средств

**Параметры отчета:**
- Дата начала периода (обязательный параметр)
- Дата окончания периода (обязательный параметр)
- Касса (опциональный параметр, для фильтрации)
- Валюта (опциональный параметр, для фильтрации)

**Функциональность:**
- Форма выбора периода (дата начала и дата окончания)
- Форма выбора кассы (опционально, для фильтрации по конкретной кассе)
- Форма выбора валюты (опционально, для фильтрации по конкретной валюте)
- Таблица с группировкой по статьям расходов:
  - **Статья расходов** (заголовок группы)
  - **Строки с расходами из авансовых отчетов:**
    - Дата расхода (из строки авансового отчета)
    - Номер авансового отчета
    - Сумма расхода (из строки авансового отчета)
    - Касса
    - Валюта
    - Сотрудник
    - Описание (из строки авансового отчета)
    - Остаток не подтвержденных или не возвращенных денег (по связанной выдаче подотчетных средств)
  - **Итог по статье расходов:**
    - Общая сумма расходов по статье за период
    - Общий остаток неотчитанных/не возвращенных средств
- Итоги по всем статьям расходов:
  - Общая сумма расходов за период
  - Общий остаток неотчитанных/не возвращенных средств
- Группировка по статьям расходов (иерархическая структура поддерживается)
- Экспорт отчета в формат XLSX
- Вывод отчета в печатный формат (PDF или печать на принтер)

**Алгоритм расчета:**
- Отчет формируется на основе расходов из авансовых отчетов (строки авансовых отчетов - AdvanceReportItem) за выбранный период
- Фильтрация по кассе и валюте (если указаны)
- Группировка по статьям расходов (IncomeExpenseItem с type='expense')
- **Примечание:** Документ «Расход денег» (ExpenseDocument) не связан с подотчетными средствами и предназначен для иных операций по кассе, связанных с выемкой денег из кассы. В данном отчете он не учитывается.
- Для каждой строки авансового отчета (AdvanceReportItem):
  - Рассчитывается остаток неотчитанных/не возвращенных средств по связанной выдаче подотчетных средств (AdvancePayment)
  - Остаток = сумма выданных подотчетных средств (AdvancePayment + AdditionalAdvancePayment) - сумма подтвержденных отчетов - сумма возвратов + сумма доплат
- Итог по статье = сумма всех расходов по статье за период (из строк авансовых отчетов)
- Общий остаток по статье = сумма остатков неотчитанных/не возвращенных средств по всем строкам авансовых отчетов в статье

**Особенности:**
- Поддержка иерархической структуры статей расходов (отображение родительских и дочерних статей)
- Отображение только активных статей расходов
- Сортировка по названию статьи расходов
- Сортировка расходов из авансовых отчетов по дате (от старых к новым)
- **Важно:** В отчете учитываются только расходы из подтвержденных авансовых отчетов (status='confirmed')
- Документ «Расход денег» (ExpenseDocument) в отчете не учитывается, так как не связан с подотчетными средствами

**URL:** `/reports/expenses-by-items/`

---

### 6.6. Отчет «История изменений документов»

**Назначение:** Просмотр истории изменений документов системы с информацией о том, кто, когда и что изменил в документах.

**Параметры отчета:**
- Дата начала периода (обязательный параметр)
- Дата окончания периода (обязательный параметр)
- Тип документа (опциональный параметр, для фильтрации по типу документа)
- Пользователь (опциональный параметр, для фильтрации по пользователю, который внес изменения)
- Номер документа (опциональный параметр, для поиска конкретного документа)

**Функциональность:**
- Форма выбора периода (дата начала и дата окончания)
- Форма выбора типа документа (опционально, для фильтрации по конкретному типу документа)
- Форма выбора пользователя (опционально, для фильтрации по конкретному пользователю)
- Поле поиска по номеру документа (опционально)
- Таблица с историей изменений документов:
  - Дата и время изменения
  - Тип документа (Оприходование денег, Расход денег, Выдача денег подотчетному лицу, Авансовый отчет, Возврат денег сотрудником, Дополнительная выдача подотчетных средств, Перемещение между кассами, Конвертация валют)
  - Номер документа
  - Дата документа
  - Пользователь, который внес изменение
  - Тип изменения (Создание, Редактирование, Удаление, Подтверждение, Изменение статуса)
  - Измененные поля (список полей, которые были изменены)
  - Старое значение (для измененных полей)
  - Новое значение (для измененных полей)
  - Комментарий к изменению (если применимо)
- Сортировка по дате и времени изменения (от новых к старым или наоборот)
- Группировка по документам (опционально, для просмотра всех изменений конкретного документа)
- Фильтрация по типу изменения (Создание, Редактирование, Удаление, Подтверждение, Изменение статуса)
- Экспорт отчета в формат XLSX
- Вывод отчета в печатный формат (PDF или печать на принтер)

**Алгоритм формирования:**
- Отчет формируется на основе истории изменений документов за выбранный период
- История изменений должна отслеживать:
  - Создание документа (кто, когда создал)
  - Редактирование документа (кто, когда, какие поля изменил, старые и новые значения)
  - Удаление документа (кто, когда удалил)
  - Подтверждение авансового отчета (кто, когда подтвердил)
  - Изменение статуса документа (кто, когда изменил статус, старый и новый статус)
- Для каждого изменения сохраняется:
  - Дата и время изменения
  - Пользователь, который внес изменение
  - Тип изменения
  - Список измененных полей с их старыми и новыми значениями
- Фильтрация по типу документа, пользователю и номеру документа (если указаны)
- Сортировка по дате и времени изменения

**Особенности:**
- История изменений должна отслеживаться для всех типов документов
- Для финансовой системы важно иметь возможность отслеживать все изменения документов
- Отчет должен отображать детальную информацию об изменениях (какие поля были изменены, старые и новые значения)
- Должна быть возможность просмотра полной истории изменений конкретного документа
- История изменений должна сохраняться даже при удалении документа (soft delete)

**Технические требования:**
- История изменений может быть реализована с использованием библиотек типа `django-simple-history` или `django-reversion`
- Альтернативно, история изменений может быть реализована через создание отдельной модели `DocumentHistory` для хранения истории изменений
- Модель истории должна содержать:
  - Ссылку на документ (ForeignKey или UUID для удаленных документов)
  - Тип документа
  - Номер документа
  - Дата и время изменения
  - Пользователь, который внес изменение
  - Тип изменения
  - JSON-поле с информацией об измененных полях (старые и новые значения)
  - Комментарий к изменению

**URL:** `/reports/document-history/`

---

## 7. Технические требования

### 7.1. База данных

**Разработка:**
- Использование SQLite для разработки и тестирования
- SQLite встроена в Python, не требует дополнительной установки
- Настройка через `settings.py`:
  ```python
  DATABASES = {
      'default': {
          'ENGINE': 'django.db.backends.sqlite3',
          'NAME': BASE_DIR / 'db.sqlite3',
      }
  }
  ```

**Промышленное применение:**
- Использование PostgreSQL для промышленного применения
- Требуется установка PostgreSQL и драйвера `psycopg2` или `psycopg2-binary`
- Настройка через `settings.py`:
  ```python
  DATABASES = {
      'default': {
          'ENGINE': 'django.db.backends.postgresql',
          'NAME': 'fin_count',
          'USER': 'user',
          'PASSWORD': 'password',
          'HOST': 'localhost',
          'PORT': '5432',
      }
  }
  ```
- Переключение между базами данных осуществляется через переменные окружения или настройки в `settings.py`
- Все модели должны быть совместимы с обеими базами данных (использование только стандартных типов полей Django)

### 7.2. Производительность
- Индексы на часто используемых полях
- Оптимизация запросов через select_related/prefetch_related
- Использование raw_id_fields для больших таблиц
- Учет особенностей производительности PostgreSQL при больших объемах данных

### 7.3. Безопасность
- Валидация данных на уровне моделей
- Защита от SQL-инъекций (ORM Django)
- Контроль доступа через Django Admin
- Безопасное хранение учетных данных базы данных (переменные окружения)

#### 7.3.1. Роли пользователей
**На данном этапе в системе должны быть реализованы следующие роли:**

1. **Администратор (полные права):**
   - Полный доступ ко всем функциям системы
   - Создание, редактирование и удаление всех документов
   - Создание, редактирование и удаление справочников
   - Подтверждение авансовых отчетов
   - Просмотр и формирование всех отчетов
   - Управление пользователями и ролями
   - Доступ к настройкам системы

2. **Пользователь только на чтение:**
   - Просмотр всех документов (без возможности редактирования, создания или удаления)
   - Просмотр всех справочников (без возможности редактирования, создания или удаления)
   - Просмотр и формирование всех отчетов
   - Просмотр журнала операций (Transaction)
   - **Ограничения:**
     - Не может создавать, редактировать или удалять документы
     - Не может создавать, редактировать или удалять справочники
     - Не может подтверждать авансовые отчеты
     - Не может изменять настройки системы

**Реализация:**
- Использование системы разрешений Django (Django Permissions)
- Настройка прав доступа через Django Admin
- Разграничение прав на уровне моделей и представлений
- Для роли "только на чтение" все формы редактирования должны быть отключены или скрыты

### 7.4. Масштабируемость
- Абстрактные модели для переиспользования
- Модульная структура приложения
- Возможность расширения функциональности
- Поддержка миграций для обеих баз данных

### 7.5. Резервное копирование и восстановление

**Назначение:** Обеспечение надежного сохранения и восстановления данных базы данных системы.

**Важно:** Резервное копирование и восстановление базы данных PostgreSQL осуществляется вне данного проекта отдельными программными средствами (например, `pg_dump`, `pg_restore`, специализированные системы резервного копирования). В рамках данного проекта реализуется только резервное копирование и восстановление для базы данных SQLite.

#### 7.5.1. Полное резервное копирование базы данных

**Требования:**
- Система должна предоставлять операцию полного резервного копирования базы данных **только для SQLite**
- Резервное копирование должно включать выгрузку всех текущих данных базы данных
- Резервная копия должна содержать полную структуру базы данных и все данные

**Реализация:**
- **Для SQLite:** создание копии файла базы данных (`db.sqlite3`)
- **Для PostgreSQL:** резервное копирование осуществляется вне проекта отдельными программными средствами (не реализуется в рамках данного проекта)
- Резервная копия должна сохраняться в указанную директорию с уникальным именем файла (например, с датой и временем создания)
- Формат имени файла резервной копии: `backup_YYYY-MM-DD_HH-MM-SS.sqlite3` (для SQLite)

**Интерфейс:**
- Операция резервного копирования должна быть доступна в Django Admin
- Доступ к операции резервного копирования должен быть только у роли "Администратор"
- При выполнении операции должна отображаться информация о процессе и результате (успешно/ошибка)
- После успешного создания резервной копии должна отображаться информация о пути к файлу резервной копии

**Технические детали:**
- Резервное копирование должно выполняться в фоновом режиме или с индикацией прогресса
- При резервном копировании база данных должна быть заблокирована для записи (или использоваться транзакционный снимок)
- Должна быть возможность указать путь для сохранения резервной копии
- По умолчанию резервные копии должны сохраняться в директорию `backups/` в корне проекта

#### 7.5.2. Восстановление базы данных из резервной копии

**Требования:**
- Система должна предоставлять операцию восстановления базы данных из резервной копии **только для SQLite**
- Восстановление должно полностью заменять текущее состояние базы данных данными из резервной копии
- Перед восстановлением должна быть создана резервная копия текущего состояния базы данных (на случай необходимости отката)

**Реализация:**
- **Для SQLite:** замена файла базы данных файлом из резервной копии
- **Для PostgreSQL:** восстановление осуществляется вне проекта отдельными программными средствами (не реализуется в рамках данного проекта)
- Перед восстановлением система должна:
  1. Создать автоматическую резервную копию текущего состояния базы данных
  2. Запросить подтверждение у пользователя о выполнении операции восстановления
  3. Выполнить проверку целостности резервной копии перед восстановлением

**Интерфейс:**
- Операция восстановления должна быть доступна в Django Admin
- Доступ к операции восстановления должен быть только у роли "Администратор"
- Должен быть интерфейс для выбора файла резервной копии из списка доступных резервных копий
- При выполнении операции должна отображаться информация о процессе и результате (успешно/ошибка)
- Должно быть предупреждение о том, что все текущие данные будут заменены данными из резервной копии

**Технические детали:**
- Восстановление должно выполняться в фоновом режиме или с индикацией прогресса
- После восстановления система должна автоматически выполнить миграции базы данных (если необходимо)
- Должна быть возможность отката к состоянию до восстановления (используя автоматически созданную резервную копию)

**Безопасность:**
- Операции резервного копирования и восстановления должны логироваться (кто, когда, что выполнил)
- Резервные копии должны храниться в безопасном месте с ограниченным доступом
- Рекомендуется хранить резервные копии на отдельном носителе или сервере

---

### 7.6. Настройки системы
- **Глобальный префикс номеров документов:** Настраиваемый параметр системы (хранится в настройках Django или в отдельной модели настроек)
- Префикс используется для генерации номеров всех документов
- Длина префикса: 2 символа
- Префикс устанавливается администратором системы
- По умолчанию может быть пустым или иметь значение по умолчанию (например, "SC")
- Настройка может быть реализована через:
  - Переменные окружения
  - Модель настроек в базе данных
  - Django settings.py

---

### 7.7. Развертывание и инфраструктура

#### 7.7.1. Виртуальная среда Python

**Назначение:** Изоляция зависимостей проекта от системных пакетов Python и других проектов.

**Требования:**
- Для разработки и промышленного применения рекомендуется использовать виртуальную среду Python
- Виртуальная среда обеспечивает изоляцию зависимостей проекта
- Предотвращает конфликты версий пакетов между разными проектами

**Создание виртуальной среды:**

**Для разработки:**
```bash
# Создание виртуальной среды
python3 -m venv venv

# Активация виртуальной среды (Linux/macOS)
source venv/bin/activate

# Активация виртуальной среды (Windows)
venv\Scripts\activate
```

**Для промышленного применения (Ubuntu Server):**
```bash
# Создание виртуальной среды
python3 -m venv /opt/fin_count/venv

# Активация виртуальной среды
source /opt/fin_count/venv/bin/activate
```

**Установка зависимостей:**
После активации виртуальной среды необходимо установить зависимости проекта:
```bash
pip install -r requirements.txt
```

**Деактивация виртуальной среды:**
```bash
deactivate
```

**Рекомендации:**
- Виртуальная среда должна быть исключена из системы контроля версий (добавлена в `.gitignore`)
- Имя директории виртуальной среды: `venv` (для разработки) или путь по выбору администратора (для production)
- При развертывании на сервере виртуальная среда должна быть создана в отдельной директории (например, `/opt/fin_count/venv`)
- Для production рекомендуется использовать отдельного системного пользователя для запуска приложения

---

#### 7.7.2. Требования к серверу (Ubuntu Server)

**Операционная система:**
- Ubuntu Server LTS (рекомендуется версия 22.04 или новее)

**Минимальные системные требования:**
- **CPU:** 2 ядра
- **RAM:** 4 GB (рекомендуется 8 GB для PostgreSQL)
- **Диск:** 20 GB свободного места (рекомендуется SSD)
- **Сеть:** стабильное интернет-соединение для обновлений

---

#### 7.7.3. Установка и настройка компонентов

**Python:**
- Python 3.10 или новее (встроен в Ubuntu 22.04)
- Проверка версии: `python3 --version`
- При необходимости обновления: `sudo apt update && sudo apt install python3.11`

**PostgreSQL:**
- PostgreSQL 14 или новее
- Установка: `sudo apt install postgresql postgresql-contrib`
- Создание базы данных и пользователя
- Настройка аутентификации

**Nginx:**
- Веб-сервер для проксирования запросов
- Установка: `sudo apt install nginx`
- Настройка конфигурации для проксирования на Gunicorn
- Настройка SSL/TLS сертификатов (Let's Encrypt)

**Gunicorn:**
- WSGI-сервер для запуска Django-приложения
- Установка через pip: `pip install gunicorn`
- Настройка systemd service для автозапуска

**Supervisor (опционально):**
- Для управления процессами
- Установка: `sudo apt install supervisor`
- Настройка конфигурации для Gunicorn

---

#### 7.7.4. Процедура развертывания

**Шаги развертывания:**

1. **Установка зависимостей системы:**
   - Python 3.10+ (обычно уже установлен)
   - PostgreSQL 14+
   - Nginx

2. **Клонирование репозитория проекта:**
   ```bash
   git clone https://github.com/michaelbag/fin_count.git
   cd fin_count
   ```

3. **Создание виртуального окружения Python:**
   ```bash
   python3 -m venv /opt/fin_count/venv
   source /opt/fin_count/venv/bin/activate
   ```

4. **Установка зависимостей проекта:**
   ```bash
   pip install -r requirements.txt
   ```

5. **Настройка переменных окружения:**
   - Создание `.env` файла с необходимыми переменными
   - Настройка `SECRET_KEY`, `DEBUG`, `ALLOWED_HOSTS`, `DATABASE_URL`

6. **Выполнение миграций базы данных:**
   ```bash
   python manage.py migrate
   ```

7. **Создание суперпользователя Django:**
   ```bash
   python manage.py createsuperuser
   ```

8. **Сбор статических файлов:**
   ```bash
   python manage.py collectstatic
   ```

9. **Настройка Gunicorn и systemd service:**
   - Создание systemd unit файла для автозапуска приложения
   - Настройка запуска через Gunicorn

10. **Настройка Nginx для проксирования:**
    - Создание конфигурационного файла Nginx
    - Настройка проксирования на Gunicorn

11. **Настройка SSL/TLS (опционально, но рекомендуется):**
    - Установка Let's Encrypt сертификата
    - Настройка автоматического обновления сертификата

12. **Запуск и проверка работы системы:**
    - Запуск systemd service
    - Проверка работы веб-сервера
    - Проверка доступности приложения

---

#### 7.7.5. Переменные окружения

**Для production рекомендуется использовать следующие переменные окружения:**

- `SECRET_KEY` - секретный ключ Django (обязательно)
- `DEBUG` - режим отладки (False для production)
- `ALLOWED_HOSTS` - разрешенные хосты (через запятую)
- `DATABASE_URL` - строка подключения к PostgreSQL (опционально, если используется переменная окружения)
- `DJANGO_SETTINGS_MODULE` - модуль настроек Django (опционально)
- Другие настройки безопасности и производительности

**Рекомендации:**
- Переменные окружения должны храниться в `.env` файле
- Файл `.env` должен быть исключен из системы контроля версий (добавлен в `.gitignore`)
- Для production рекомендуется использовать системные переменные окружения или файлы конфигурации с ограниченным доступом

---

#### 7.7.6. Мониторинг системы

**Требования к мониторингу:**
- Мониторинг использования ресурсов (CPU, RAM, диск)
- Мониторинг работы веб-сервера (Nginx)
- Мониторинг работы приложения (Gunicorn/Django)
- Логирование ошибок и критических событий
- Настройка автоматических уведомлений при проблемах

**Рекомендуемые инструменты:**
- Системные утилиты: `htop`, `df`, `free`
- Логирование: системный журнал (journalctl), логи Nginx, логи Gunicorn
- Мониторинг: опционально использование специализированных систем мониторинга

---

#### 7.7.7. Безопасность

**Требования к безопасности:**
- Настройка файрвола (ufw): открытие только необходимых портов (80, 443, 22)
- Регулярные обновления системы: `sudo apt update && sudo apt upgrade`
- Настройка SSH с ключами вместо паролей
- Ограничение доступа к административным интерфейсам
- Использование HTTPS для production (SSL/TLS сертификаты)
- Ограничение доступа к базе данных (только с localhost или через VPN)

**Рекомендации:**
- Регулярное резервное копирование базы данных
- Мониторинг попыток несанкционированного доступа
- Использование сильных паролей для всех учетных записей
- Регулярный аудит безопасности системы

---

## 8. Этапы реализации

### 8.1. Абстрактные базовые модели
- [ ] BaseDocument (Документ) - абстрактная модель с UUID первичным ключом
- [ ] BaseOperationRegister (Регистр операций) - абстрактная модель
- [ ] BaseAccumulationRegister (Регистр накоплений) - абстрактная модель
- [ ] BaseReference (Справочники) - абстрактная модель с UUID первичным ключом

### 8.2. Справочники
- [x] Currency (Валюта) - конкретная модель, наследуется от BaseReference
- [x] CashRegister (Касса) - конкретная модель, наследуется от BaseReference
- [x] IncomeExpenseItem (Статья доходов/расходов) - конкретная модель, наследуется от BaseReference
- [x] Employee (Сотрудник) - конкретная модель, наследуется от BaseReference, с автоматическим заполнением наименования полным ФИО
- [x] CurrencyRate (Курс валют) - конкретная модель, наследуется от BaseReference, с историей курсов по датам, точность курса до десятитысячных (4 знака после запятой), автоматическое заполнение наименования, интерфейс формы с отображением кода валюты и подсказками

### 8.3. Регистр операций
- [ ] Transaction (Операция) - конкретная модель, наследуется от BaseOperationRegister

### 8.4. Документы
- [ ] IncomeDocument (Оприходование денег)
- [ ] ExpenseDocument (Расход денег)
- [ ] AdvancePayment (Выдача денег подотчетному лицу)
- [ ] AdvanceReport (Авансовый отчет)
- [ ] AdvanceReportItem (Строки отчета)
- [ ] AdvanceReturn (Возврат денег сотрудником - отдельный документ)
- [ ] AdditionalAdvancePayment (Дополнительная выдача подотчетных средств)
- [ ] CashTransfer (Перемещение между кассами)
- [ ] CurrencyConversion (Конвертация валют)

### 8.5. Бизнес-логика
- [x] Генерация номеров документов (автоматическая генерация при сохранении, если номер пустой)
- [x] Настройка глобального префикса номеров документов (модель настроек или settings.py)
- [x] Генерация кода справочника (автоматическая генерация при сохранении, если код пустой, аналогично генерации номеров документов)
- [x] Автоматическое заполнение наименования Employee полным ФИО (если наименование не указано пользователем)
- [x] Автоматическое заполнение наименования CurrencyRate на основе кодов валют и курса (если наименование не указано пользователем)
- [ ] Базовые методы расчета остатков в BaseAccumulationRegister (используют регистр накоплений)
- [ ] Реализация отслеживания истории изменений документов (модель DocumentHistory или использование библиотеки django-simple-history/django-reversion)
- [ ] Автоматическое сохранение истории изменений при создании, редактировании, удалении документов
- [ ] Сохранение истории изменений при подтверждении авансовых отчетов и изменении статусов документов
- [ ] Автоматическое создание операций при создании документов (IncomeDocument, ExpenseDocument, AdvancePayment, AdvanceReturn, AdditionalAdvancePayment)
- [ ] Автоматическая установка поля `is_posted` в `true` при создании операций (документ отразился в учете)
- [ ] Автоматическая установка поля `is_posted` в `false` при удалении операций (для авансовых отчетов при изменении статуса)
- [ ] Автоматическая установка поля `is_posted` в `false` при установке `is_deleted` в `true`
- [ ] Исключение документов с `is_deleted=True` из расчетов остатков и отчетов
- [ ] Исключение операций, связанных с документами с `is_deleted=True`, из расчетов
- [ ] Логика подтверждения авансовых отчетов (только подтвержденные отражаются в остатках)
- [ ] Удаление операций при изменении статуса авансового отчета с 'confirmed' на другой
- [ ] Расчет возврата и доплаты
- [ ] Валидация сумм возврата и доплаты в авансовых отчетах
- [ ] Валидация суммы возврата в документах AdvanceReturn
- [ ] Проверка на отрицательные суммы во всех документах
- [ ] Управление закрытием подотчетных средств (один документ выдачи может закрываться несколькими отчетами)
- [ ] Расчет остатков по кассам и по выданным авансам (с учетом возвратов, дополнительных выдач и доплат)
- [ ] Валидация для CashTransfer (проверка совпадения касс, наличия достаточного остатка, положительных сумм)
- [ ] Валидация для CurrencyConversion (проверка совпадения валют, наличия достаточного остатка, положительного курса, соответствия курса и сумм, положительных сумм)
- [ ] Автоматическое заполнение курса обмена в CurrencyConversion из справочника CurrencyRate
- [ ] Автоматический расчет суммы в целевой валюте при изменении суммы в исходной валюте или курса в CurrencyConversion

### 8.6. Интерфейс
- [x] Регистрация всех моделей в админке
- [x] Настройка фильтров и поиска
- [x] Inline-редактирование
- [x] Автоматический расчет сумм в формах
- [x] Кастомные формы для CurrencyRate (отображение кода валюты вместо ID, подсказки о применении курса)
- [x] Кастомные формы для Employee (автоматическое заполнение наименования полным ФИО)
- [ ] Реализация системы ролей пользователей (Администратор с полными правами, Пользователь только на чтение)
- [ ] Настройка прав доступа через Django Permissions
- [ ] Разграничение прав на уровне моделей и представлений для роли "только на чтение"

### 8.7. Отчеты
- [ ] Отчет о текущем состоянии остатков по кассам
- [ ] Отчет об операциях и движениях денег за период
- [ ] Отчет об остатках по подотчетным деньгам
- [ ] Касса по дням
- [ ] Отчет «Расход денежных средств по статьям»
- [ ] Отчет «История изменений документов»
- [ ] Формы для параметров отчетов
- [ ] Реализация экспорта всех отчетов в формат XLSX (Excel)
- [ ] Реализация вывода всех отчетов в печатный формат (PDF или печать на принтер)
- [ ] Форматирование экспортируемых отчетов (заголовки, итоги, группировки)
- [ ] Предварительный просмотр перед печатью

### 8.8. Резервное копирование и восстановление
- [ ] Реализация операции полного резервного копирования базы данных SQLite (для PostgreSQL резервное копирование осуществляется вне проекта)
- [ ] Интерфейс для создания резервной копии в Django Admin (только для администратора, только для SQLite)
- [ ] Автоматическое именование резервных копий с датой и временем
- [ ] Реализация операции восстановления базы данных SQLite из резервной копии (для PostgreSQL восстановление осуществляется вне проекта)
- [ ] Автоматическое создание резервной копии перед восстановлением
- [ ] Интерфейс для выбора и восстановления из резервной копии в Django Admin (только для администратора, только для SQLite)
- [ ] Проверка целостности резервной копии перед восстановлением
- [ ] Логирование операций резервного копирования и восстановления

### 8.9. Развертывание и инфраструктура
- [ ] Создание инструкции по настройке виртуальной среды Python для разработки
- [ ] Создание инструкции по развертыванию на Ubuntu Server
- [ ] Настройка systemd service для автозапуска приложения через Gunicorn
- [ ] Настройка Nginx для проксирования запросов на Gunicorn
- [ ] Настройка SSL/TLS сертификатов (Let's Encrypt)
- [ ] Настройка мониторинга системы (CPU, RAM, диск, веб-сервер, приложение)
- [ ] Настройка безопасности (файрвол, SSH ключи, ограничение доступа)
- [ ] Документирование процедуры развертывания с пошаговыми командами

---

## 9. Примечания

- Все даты операций устанавливаются по дате документа
- Операции привязываются к документам, а не наоборот
- Поддержка мультивалютного учета обязательна
- Интерфейс полностью на русском языке
- Проект работает в режиме отладки с доступом на всех IP-адресах
- **Остатки хранятся в системе по кассам и по выданным авансам сотрудникам**
- **Только подтвержденные авансовые отчеты отражаются в движениях по остаткам**
- **Каждый документ выдачи денег закрывается одним или несколькими авансовыми отчетами**
- **Возврат денег может осуществляться как отдельным документом (AdvanceReturn), так и в рамках авансового отчета**
- **Дополнительная выдача подотчетных средств (AdditionalAdvancePayment) привязана к первоначальной выдаче и учитывается при расчете остатков**
- **Журнал операций (Transaction) - это общий журнал со ссылками на документы, физические лица, валюты, статьи расходов и доходов**
- **ВАЖНО: Закрытие (подтверждение) сотрудником ранее выданных денег должно происходить строго по той же статье расходов, по которой деньги выдавались. Система должна выполнять обязательную валидацию соответствия статей расходов при создании авансового отчета и блокировать сохранение отчета при несоответствии.**

---

**Статус документа:** Черновик  
**Дата последнего обновления:** 09.11.2025  
**Версия документа:** 2.0


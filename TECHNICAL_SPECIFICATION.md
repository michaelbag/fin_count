# Техническое задание
## Система финансового учета (fin_count)

**Версия документа:** 1.8  
**Дата создания:** 07.11.2025  
**Дата обновления:** 08.11.2025  
**Проект:** fin_count  
**Версия проекта:** 0.0.1  
**Статус проекта:** В разработке документации

---

## 1. Общие сведения

### 1.1. Назначение системы
Система предназначена для ведения финансового учета с поддержкой мультивалютного учета, управления подотчетными средствами и ведения журнала операций.

### 1.2. Технологический стек
- **Backend:** Django 5.2.8
- **База данных:** 
  - SQLite (для разработки)
  - PostgreSQL (для промышленного применения)
- **Язык:** Python 3.11
- **Интерфейс:** Django Admin + пользовательские формы

### 1.3. Требования к системе
- Python 3.11+
- Django 5.2.8
- База данных:
  - SQLite (для разработки) - встроена в Python
  - PostgreSQL (для промышленного применения) - требуется установка и настройка
- Поддержка мультивалютного учета
- Режим отладки для разработки
- Доступ на всех IP-адресах рабочего места

---

## 2. Функциональные требования

### 2.1. Основные функции системы

Система должна обеспечивать выполнение следующих функций:

#### 2.1.1. Учет остатков денежных средств
- Учет остатков денежных средств по кассам в различных валютах
- Расчет остатков на произвольную дату
- Хранение остатков в системе (динамический расчет на основе операций)
- Отображение остатков по каждой кассе и валюте

#### 2.1.2. Учет подотчетных средств
- Учет остатков по выданным авансам сотрудникам
- Расчет остатков неотчитанных средств по каждому сотруднику
- Расчет остатков по конкретной выдаче подотчетных средств
- Учет только подтвержденных авансовых отчетов при расчете остатков

#### 2.1.3. Оформление операций документами
Система должна поддерживать следующие типы документов:
- **Оприходование денег** - документ поступления денежных средств в кассу
- **Расход денег** - документ расхода денежных средств из кассы
- **Выдача денег подотчетному лицу (сотруднику)** - документ выдачи подотчетных средств
- **Авансовые отчеты** - документы по фактическим тратам сотрудника
- **Возврат денег сотрудником** - отдельный документ возврата неиспользованных средств (полный или частичный возврат от выдачи)
- **Дополнительная выдача подотчетных средств** - документ дополнительной выдачи, привязанный к первоначальной выдаче
- **Перемещение между кассами** - документ перемещения денежных средств между кассами
- **Конвертация валют** - документ конвертации одной валюты в другую

#### 2.1.4. Журнал операций
- Ведение общего журнала операций со ссылками на:
  - Документы (все типы документов)
  - Физические лица (сотрудники)
  - Валюты
  - Статьи расходов и доходов
- Автоматическое создание записей в журнале при создании документов
- Обновление записей при редактировании документов
- Удаление записей при удалении документов

#### 2.1.5. Справочники
- Ведение справочника валют
- Ведение справочника касс
- Ведение справочника статей расходов и доходов (с поддержкой иерархии)
- Ведение справочника сотрудников

---

### 2.2. Требования к справочникам

#### 2.2.1. Справочник валют
- Возможность добавления, редактирования и деактивации валют
- Уникальность кода валюты (ISO 4217)
- Отображение символа валюты
- Фильтрация по активности
- Поиск по коду и названию

#### 2.2.2. Справочник касс
- Возможность добавления, редактирования и деактивации касс
- Отображение остатков по валютам в списке касс
- Расчет остатков на произвольную дату
- Фильтрация по активности

#### 2.2.3. Справочник статей доходов/расходов
- Возможность добавления, редактирования и деактивации статей
- Разделение на доходы и расходы
- Поддержка иерархической структуры (родитель-потомок)
- Фильтрация по типу и активности

#### 2.2.4. Справочник сотрудников
- Возможность добавления, редактирования и деактивации сотрудников
- Хранение ФИО и должности
- Расчет остатков подотчетных средств по сотруднику
- Фильтрация по активности
- Поиск по ФИО и должности

---

### 2.3. Требования к документам

#### 2.3.1. Оприходование денег
- Создание документа с указанием кассы, валюты, суммы, статьи доходов
- Автоматическое создание операции в журнале операций при сохранении документа
- Обновление операции при редактировании документа
- Фильтрация по кассе, валюте, статье доходов, сотруднику

#### 2.3.2. Расход денег
- Создание документа с указанием кассы, валюты, суммы, статьи расходов
- Автоматическое создание операции в журнале операций при сохранении документа
- Обновление операции при редактировании документа
- Фильтрация по кассе, валюте, статье расходов, сотруднику

#### 2.3.3. Выдача денег подотчетному лицу (сотруднику)
- Создание документа с указанием сотрудника, кассы, суммы, валюты, статьи расходов, цели выдачи
- Автоматическое создание операции в журнале операций (расход из кассы)
- Обновление операции при редактировании документа
- Отображение остатка неотчитанных средств в списке выдач
- Возможность закрытия выдачи (автоматически или вручную)
- Фильтрация по сотруднику, валюте, статье расходов, статусу закрытия

#### 2.3.4. Авансовый отчет
- Создание документа с привязкой к выданным подотчетным средствам
- Добавление строк отчета с указанием статьи расходов, суммы, описания, даты расхода
- Автоматический расчет общей суммы из суммы всех строк
- Автоматический расчет суммы возврата и доплаты
- Возможность ручного указания сумм возврата и доплаты
- Статусы отчета (значение в коде → отображаемое имя): `draft` → «Черновик», `submitted` → «Сдан», `approved` → «Подтвержден», `rejected` → «Отклонен»
- **Только подтвержденные отчеты отражаются в движениях по остаткам**
- При подтверждении отчета:
  - Создание операций построчно по каждой строке отчета
  - Создание операции возврата (если есть возврат в рамках отчета)
  - Создание операции доплаты (если есть доплата)
  - Возможность закрытия подотчетных средств или создания новой выдачи при доплате
- Обновление операций при редактировании подтвержденного отчета
- Удаление операций для удаленных строк отчета
- Встроенное редактирование строк отчета (inline-редактирование)
- Поле `description` («Описание») в строках — однострочное
- Массовое подтверждение отчетов
- Фильтрация по сотруднику, статусу, валюте
- **Примечание:** Возврат денег может осуществляться как в рамках авансового отчета, так и отдельным документом возврата (AdvanceReturn)

---

**Требование:** При закрытии (подтверждении) сотрудником ранее выданных подотчетных средств в авансовом отчете, строки отчета должны использовать строго ту же статью расходов, по которой была произведена первоначальная выдача денег.

**Валидация:** Система должна проверять соответствие статей расходов в строках авансового отчета (AdvanceReportItem.item) статье расходов, указанной при выдаче подотчетных средств (AdvancePayment.expense_item). При несоответствии система должна блокировать сохранение отчета до исправления статьи расходов.

---

#### 2.3.5. Перемещение между кассами
- Создание документа с указанием исходной и целевой кассы, валюты, суммы
- Автоматическое создание двух операций:
  - Списание из исходной кассы (отрицательная сумма)
  - Поступление в целевую кассу (положительная сумма)

#### 2.3.6. Конвертация валют
- Создание документа с указанием исходной и целевой валюты, кассы, сумм, курса обмена
- Автоматическое создание двух операций:
  - Списание исходной валюты (отрицательная сумма)
  - Поступление целевой валюты (положительная сумма)

#### 2.3.7. Возврат денег сотрудником
- Создание отдельного документа возврата денег с привязкой к выданным подотчетным средствам (AdvancePayment)
- Указание сотрудника, кассы, суммы возврата, валюты
- Возможность полного или частичного возврата от первоначальной выдачи
- Автоматическое создание операции в журнале операций (положительная сумма - поступление в кассу)
- Обновление операции при редактировании документа
- Влияние на расчет остатков подотчетных средств
- Фильтрация по сотруднику, валюте, связанной выдаче

#### 2.3.8. Дополнительная выдача подотчетных средств
- Создание документа дополнительной выдачи с привязкой к первоначальной выдаче (AdvancePayment)
- Указание сотрудника, кассы, суммы дополнительной выдачи, валюты, цели выдачи
- Автоматическое создание операции в журнале операций (отрицательная сумма - расход из кассы)
- Обновление операции при редактировании документа
- Влияние на расчет остатков подотчетных средств
- Фильтрация по сотруднику, валюте, связанной первоначальной выдаче

---

### 2.4. Требования к журналу операций

#### 2.4.1. Общие требования
- Отображение всех операций с указанием типа, даты, суммы, кассы, валюты
- Связь операций с документами через ForeignKey
- Связь операций с сотрудниками, статьями доходов/расходов
- Дата операции устанавливается по дате документа
- Сумма может быть положительной (поступление) или отрицательной (расход)

#### 2.4.2. Типы операций
- Оприходование денег
- Расход денег
- Выдача подотчетных
- Авансовый отчет (строка отчета)
- Возврат денег сотрудником (отдельный документ возврата)
- Возврат денег по авансовому отчету (в рамках авансового отчета)
- Дополнительная выдача подотчетных средств
- Доплата по авансовому отчету
- Перемещение между кассами
- Конвертация валют

#### 2.4.3. Фильтрация и поиск
- Фильтры по типу, валюте, кассе, дате, сотруднику, статье
- Иерархия дат для навигации
- Поиск по описанию
- Отображение всех связей с документами

---

### 2.5. Требования к расчету остатков

#### 2.5.1. Остатки по кассам
- Расчет на основе всех операций по кассе и валюте
- Поддержка расчета на произвольную дату
- Динамический расчет (не хранятся в базе, рассчитываются по запросу)
- Метод: `CashRegister.get_balance(currency, date=None)`

#### 2.5.2. Остатки по выданным авансам
- **Формула расчета остатка:**
  ```
  Остаток = (Выдача подотчетных средств + Дополнительная выдача подотчетных средств) 
            - Авансовый отчет (подтвержденный) 
            - (Возврат денег сотрудником + возвраты по авансовым отчетам) 
            + доплаты по авансовым отчетам
  ```
- **Компоненты расчета:**
  - Выданные суммы: сумма первоначальной выдачи подотчетных средств (AdvancePayment) и всех дополнительных выдач подотчетных средств (AdditionalAdvancePayment)
  - Подтвержденные отчеты: сумма всех подтвержденных авансовых отчетов (AdvanceReport) по данной выдаче
  - Возвраты: сумма всех возвратов (отдельные документы возврата денег сотрудником (AdvanceReturn) + возвраты по авансовым отчетам)
  - Доплаты: сумма всех доплат по авансовым отчетам
- **Условие закрытия выдачи:** Выдача считается закрытой, когда остаток равен нулю, т.е. когда сумма всех подтвержденных отчетов равна сумме выдачи с учетом возвратов и доплат (см. раздел 2.5.3)
- Учет только операций из подтвержденных авансовых отчетов
- Учет всех операций возврата (отдельные документы и возвраты по авансовым отчетам)
- Учет всех дополнительных выдач подотчетных средств
- Динамический расчет (не хранятся в базе, рассчитываются по запросу)
- Метод: `Employee.get_advance_balance(currency)` - остаток по сотруднику
- Метод: `AdvancePayment.get_unreported_balance()` - остаток по конкретной выдаче (с учетом дополнительных выдач, возвратов и доплат)

#### 2.5.3. Закрытие выдачи подотчетных средств
- Каждый документ выдачи денег может быть закрыт одним или несколькими авансовыми отчетами
- Выдача считается закрытой, когда сумма всех подтвержденных отчетов по ней равна сумме выдачи (с учетом возвратов и доплат)

---

### 2.6. Требования к отчетам

Система должна обеспечивать формирование следующих отчетов:

#### 2.6.1. Отчет о текущем состоянии остатков по кассам
- Форма выбора даты отчета
- Таблица с остатками по всем кассам и валютам на выбранную дату
- Строка итогов по каждой валюте
- Отображение нулевых остатков
- URL: `/reports/cash-balance/`

#### 2.6.2. Отчет об операциях и движениях денег за период
- Форма выбора периода (дата начала и дата окончания)
- Форма выбора кассы (опционально, для фильтрации)
- Форма выбора валюты (опционально, для фильтрации)
- Таблица с операциями за период:
  - Дата операции
  - Тип операции
  - Документ-основание
  - Сотрудник (если применимо)
  - Статья доходов/расходов
  - Сумма (положительная или отрицательная)
  - Описание
- Входящий остаток на начало периода (по каждой кассе и валюте)
- Исходящий остаток на конец периода (по каждой кассе и валюте)
- Обороты за период (приход и расход)
- Итоги по кассам и валютам
- URL: `/reports/transactions-period/`

#### 2.6.3. Отчет об остатках по подотчетным деньгам
- Форма выбора даты отчета
- Форма выбора сотрудника (опционально, для фильтрации)
- Форма выбора валюты (опционально, для фильтрации)
- Таблица с остатками по подотчетным средствам:
  - Сотрудник
  - Валюта
  - Выданная сумма (сумма всех выдач)
  - Отчитанная сумма (сумма всех подтвержденных отчетов)
  - Возвращенная сумма (сумма всех возвратов)
  - Доплаченная сумма (сумма всех доплат)
  - Текущий остаток (неотчитанные средства)
- Детализация по каждому сотруднику:
  - Список выдач подотчетных средств с датами и суммами
  - Список авансовых отчетов с датами, суммами, статусами
  - Список возвратов денег с датами и суммами
  - Список доплат с датами и суммами
- Итоги по валютам
- URL: `/reports/advance-balance/`

#### 2.6.4. Отчет «Касса по дням»
- Форма выбора периода (дата начала и дата окончания)
- Форма выбора сотрудника (опционально, для фильтрации)
- Форма выбора валюты (опционально, для фильтрации)
- Таблица с операциями по подотчетным средствам:
  - № документа выдачи / возврата / авансового отчета
  - От кого получено или кому выдано (сотрудник)
  - Приход (положительные суммы)
  - Расход (отрицательные суммы)
  - Основание (описание)
- Итоги по приходу и расходу
- URL: `/reports/advance-operations/`

#### 2.6.5. Отчет «Расход денежных средств по статьям»
- Форма выбора периода (дата начала и дата окончания)
- Форма выбора кассы (опционально, для фильтрации)
- Форма выбора валюты (опционально, для фильтрации)
- Таблица с группировкой по статьям расходов:
  - Статья расходов
  - Строки с датами документов расхода по кассе
  - Остатки не подтвержденных или не возвращенных денег
- Итоги по статьям расходов
- URL: `/reports/expenses-by-items/`

---

### 2.7. Требования к интерфейсу

#### 2.7.1. Общие требования
- Интерфейс полностью на русском языке
- Все модели зарегистрированы в Django Admin
- Поддержка фильтров и поиска для всех моделей
- Использование `raw_id_fields` для оптимизации при большом количестве записей
- Использование `autocomplete_fields` где необходимо

#### 2.7.2. Требования к формам
- Автоматический расчет сумм в формах (общая сумма авансового отчета, возврат, доплата)
- Inline-редактирование строк авансового отчета
- Однострочное поле description в строках авансового отчета
- Валидация данных на уровне форм

---

## 3. Модели данных

### 3.1. Абстрактные базовые модели

В системе используются 4 абстрактные базовые модели, которые определяют общую структуру и поведение для всех объектов системы:

**Общие требования к реализации:**
- Абстрактные модели BaseDocument и BaseReference должны использовать UUID (GUID) в качестве первичного ключа
- Регистры (BaseOperationRegister, BaseAccumulationRegister) могут использовать стандартный автоинкрементный первичный ключ
- UUID обеспечивает уникальность записей и удобен для распределенных систем

#### 3.1.1. BaseDocument (Документ)
**Назначение:** Базовая модель для всех документов системы

**Поля:**
- `id` (UUIDField, primary_key=True, default=uuid.uuid4, editable=False) - Уникальный идентификатор (GUID)
- `number` (CharField, max_length=50, unique=True) - Номер документа
- `date` (DateTimeField) - Дата документа (устанавливается автоматически при сохранении, если не указана)
- `is_posted` (BooleanField, default=False) - Статус "Проведен" (отражен в учете)
- `is_deleted` (BooleanField, default=False) - Пометка на удаление
- `created_at` (DateTimeField, auto_now_add=True) - Дата создания
- `updated_at` (DateTimeField, auto_now=True) - Дата обновления

**Методы:**
- `save()` - Автоматически устанавливает дату на текущий момент, если она не указана

**Наследуют:**
- IncomeDocument (Оприходование денег)
- ExpenseDocument (Расход денег)
- AdvancePayment (Выдача денег подотчетному лицу)
- AdvanceReport (Авансовый отчет)
- AdvanceReturn (Возврат денег сотрудником)
- AdditionalAdvancePayment (Дополнительная выдача подотчетных средств)
- CashTransfer (Перемещение между кассами)
- CurrencyConversion (Конвертация валют)

---

#### 3.1.2. BaseOperationRegister (Регистр операций)
**Назначение:** Базовая модель для регистра операций (журнала операций)

**Поля:**
- `date` (DateTimeField) - Дата операции
- `transaction_type` (CharField, choices) - Тип операции
- `amount` (DecimalField) - Сумма операции
- `description` (TextField, blank=True) - Описание операции
- `created_at` (DateTimeField, auto_now_add=True) - Дата создания записи
- `created_by` (ForeignKey, User, null=True, blank=True) - Создано пользователем

**Особенности:**
- Регистр операций не имеет остатков, только движения
- Каждая операция отражает факт хозяйственной деятельности
- Операции привязываются к документам через ForeignKey

**Наследуют:**
- Transaction (Операция / Журнал операций)

---

#### 3.1.3. BaseAccumulationRegister (Регистр накоплений)
**Назначение:** Базовая модель для регистров накоплений (остатков)

**Поля:**
- `date` (DateTimeField) - Дата записи
- `period` (DateField) - Период (для расчета остатков на дату)
- `created_at` (DateTimeField, auto_now_add=True) - Дата создания записи

**Особенности:**
- Регистр накоплений хранит остатки и обороты
- Остатки рассчитываются на основе операций из регистра операций
- Поддерживает расчет остатков на произвольную дату

**Использование:**
- Остатки по кассам (CashRegister.get_balance)
- Остатки по выданным авансам (Employee.get_advance_balance)
- Остатки рассчитываются динамически на основе операций из регистра операций

---

#### 3.1.4. BaseReference (Справочники)
**Назначение:** Базовая модель для всех справочников системы

**Поля:**
- `id` (UUIDField, primary_key=True, default=uuid.uuid4, editable=False) - Уникальный идентификатор (GUID)
- `name` (CharField, max_length=200) - Название элемента справочника
- `code` (CharField, max_length=50, unique=True, blank=True, null=True) - Код элемента (опционально)
- `description` (TextField, blank=True) - Описание
- `is_active` (BooleanField, default=True) - Активен
- `created_at` (DateTimeField, auto_now_add=True) - Дата создания
- `updated_at` (DateTimeField, auto_now=True) - Дата обновления

**Особенности:**
- Справочники содержат относительно статичную информацию
- Элементы справочников используются в документах и операциях
- Поддержка иерархической структуры через поле `parent` (опционально)

**Наследуют:**
- Currency (Валюта)
- CashRegister (Касса)
- IncomeExpenseItem (Статья доходов/расходов)
- Employee (Сотрудник)

---

### 3.2. Справочники

Все справочники наследуются от `BaseReference` и дополняют базовую модель специфичными полями.

**Примечание:** Все справочники, наследующиеся от `BaseReference`, автоматически получают UUID (GUID) в качестве первичного ключа.

#### 3.2.1. Currency (Валюта)
**Назначение:** Справочник валют

**Наследует:** BaseReference

**Дополнительные поля:**
- `code` (CharField, max_length=3, unique=True) - Код валюты (ISO 4217) (переопределяет code из BaseReference)
- `symbol` (CharField, max_length=10) - Символ валюты

**Требования:**
- Код валюты должен быть уникальным
- По умолчанию валюта активна

---

#### 3.2.2. CashRegister (Касса)
**Назначение:** Справочник касс

**Наследует:** BaseReference

**Дополнительные поля:**
- (используются поля из BaseReference: name, description, is_active)

**Методы:**
- `get_balance(currency, date=None)` - Получить остаток по кассе в указанной валюте на определенную дату (использует регистр накоплений)

**Требования:**
- Должна быть возможность расчета остатков по каждой валюте
- Остатки рассчитываются на основе операций из регистра операций (Transaction)

---

#### 3.2.3. IncomeExpenseItem (Статья доходов/расходов)
**Назначение:** Справочник статей доходов и расходов

**Наследует:** BaseReference

**Дополнительные поля:**
- `type` (CharField, choices=['income', 'expense']) - Тип: Доход/Расход
- `parent` (ForeignKey, self, null=True, blank=True) - Родительская статья (для иерархии)

**Требования:**
- Поддержка иерархической структуры (родитель-потомок)
- Разделение на доходы и расходы

---

#### 3.2.4. Employee (Сотрудник)
**Назначение:** Справочник сотрудников

**Наследует:** BaseReference

**Дополнительные поля:**
- `first_name` (CharField, max_length=100) - Имя
- `last_name` (CharField, max_length=100) - Фамилия
- `middle_name` (CharField, max_length=100, blank=True) - Отчество
- `position` (CharField, max_length=200, blank=True) - Должность

**Методы:**
- `full_name` (property) - Полное имя сотрудника (формируется из first_name, last_name, middle_name)
- `get_advance_balance(currency)` - Получить остаток подотчетных средств в указанной валюте (использует регистр накоплений)

---

### 3.3. Документы

Все документы наследуются от `BaseDocument` и дополняют базовую модель специфичными полями и бизнес-логикой.

**Примечание:** Все документы, наследующиеся от `BaseDocument`, автоматически получают UUID (GUID) в качестве первичного ключа.

#### 3.3.1. AdvancePayment (Выдача денег подотчетному лицу)
**Назначение:** Документ выдачи подотчетных денег сотруднику

**Наследует:** BaseDocument

**Дополнительные поля (к полям BaseDocument):**
- `employee` (ForeignKey, Employee) - Сотрудник
- `cash_register` (ForeignKey, CashRegister) - Касса
- `amount` (DecimalField, max_digits=15, decimal_places=2) - Сумма выдачи
- `currency` (ForeignKey, Currency) - Валюта
- `expense_item` (ForeignKey, IncomeExpenseItem) - Статья расходов, по которой выдаются подотчетные средства
- `purpose` (TextField) - Цель выдачи
- `is_closed` (BooleanField, default=False) - Закрыто
- `closed_at` (DateTimeField, null=True, blank=True) - Дата закрытия

**Примечание:** Дата выдачи хранится в поле `date` базовой модели BaseDocument

**Методы:**
- `close()` - Закрыть подотчетные средства
- `get_unreported_balance()` - Получить остаток неотчитанных средств

**Бизнес-логика:**
- При создании документа автоматически создается операция (Transaction) с отрицательной суммой (расход из кассы)
- Операция привязывается к документу через ForeignKey
- При редактировании документа операция обновляется, а не создается заново

---

#### 3.3.2. AdvanceReport (Авансовый отчет)
**Назначение:** Документ авансового отчета сотрудника по фактическим тратам

**Наследует:** BaseDocument

**Дополнительные поля (к полям BaseDocument):**
- `advance_payment` (ForeignKey, AdvancePayment) - Подотчетные средства
- `total_amount` (DecimalField) - Общая сумма расходов
- `return_amount` (DecimalField, default=0.00) - Сумма возврата (автоматически рассчитывается)
- `additional_payment` (DecimalField, default=0.00) - Сумма доплаты (автоматически рассчитывается)
- `currency` (ForeignKey, Currency) - Валюта
- `close_advance_payment` (BooleanField, default=True) - Закрыть подотчетные средства
- `manual_return_amount` (DecimalField, default=0.00) - Возврат денег (ручной)
- `manual_additional_payment` (DecimalField, default=0.00) - Дополнительная выдача (ручная)
- `status` (CharField, choices) - Статус: Черновик, Сдан, Подтвержден, Отклонен
- `approved_at` (DateTimeField, null=True, blank=True) - Дата подтверждения
- `approved_by` (ForeignKey, User, null=True, blank=True) - Подтверждено пользователем

**Методы:**
- `calculate_return_and_additional()` - Рассчитать сумму возврата и доплаты
- `approve(user)` - Подтвердить авансовый отчет

**Бизнес-логика:**
- Каждый документ выдачи денег (AdvancePayment) может быть закрыт одним или несколькими авансовыми отчетами
- При подтверждении отчета (status='confirmed'):
  - Создаются операции построчно по каждой строке отчета (AdvanceReportItem)
  - Создается операция возврата (если есть возврат)
  - Создается операция доплаты (если есть доплата)
  - Если `close_advance_payment=True`, подотчетные средства закрываются
  - Если `close_advance_payment=False` и есть доплата, создается новая выдача подотчетных средств
- **Только подтвержденные отчеты (status='confirmed') отражаются в движениях по остаткам**
- При редактировании подтвержденного отчета операции обновляются
- Общая сумма (`total_amount`) автоматически рассчитывается из суммы всех строк, если не заполнена
- Используются ручные суммы возврата/доплаты, если они указаны (отличны от 0)

---

#### 3.3.3. AdvanceReportItem (Строка авансового отчета)
**Назначение:** Строка авансового отчета с детализацией расходов

**Поля:**
- `report` (ForeignKey, AdvanceReport) - Авансовый отчет
- `item` (ForeignKey, IncomeExpenseItem) - Статья расходов
- `amount` (DecimalField) - Сумма
- `description` (TextField) - Описание (однострочное поле)
- `date` (DateTimeField) - Дата расхода
- `transaction` (OneToOneField, Transaction, null=True, blank=True) - Операция

**Требования:**
- Поле description должно быть однострочным в форме редактирования

---

#### 3.3.4. AdvanceReturn (Возврат денег сотрудником)
**Назначение:** Отдельный документ возврата денег сотрудником (полный или частичный возврат от выдачи)

**Наследует:** BaseDocument

**Дополнительные поля (к полям BaseDocument):**
- `advance_payment` (ForeignKey, AdvancePayment) - Выдача подотчетных средств, к которой относится возврат
- `employee` (ForeignKey, Employee) - Сотрудник
- `cash_register` (ForeignKey, CashRegister) - Касса
- `amount` (DecimalField, max_digits=15, decimal_places=2) - Сумма возврата
- `currency` (ForeignKey, Currency) - Валюта
- `description` (TextField, blank=True) - Описание возврата

**Примечание:** Дата возврата хранится в поле `date` базовой модели BaseDocument

**Бизнес-логика:**
- При создании документа автоматически создается операция (Transaction) с положительной суммой (поступление в кассу)
- Операция привязывается к документу через ForeignKey
- При редактировании документа операция обновляется, а не создается заново
- Возврат влияет на расчет остатков подотчетных средств
- Возможен полный или частичный возврат от первоначальной выдачи

---

#### 3.3.5. AdditionalAdvancePayment (Дополнительная выдача подотчетных средств)
**Назначение:** Документ дополнительной выдачи подотчетных средств, привязанный к первоначальной выдаче

**Наследует:** BaseDocument

**Дополнительные поля (к полям BaseDocument):**
- `original_advance_payment` (ForeignKey, AdvancePayment) - Первоначальная выдача подотчетных средств
- `employee` (ForeignKey, Employee) - Сотрудник
- `cash_register` (ForeignKey, CashRegister) - Касса
- `amount` (DecimalField, max_digits=15, decimal_places=2) - Сумма дополнительной выдачи
- `currency` (ForeignKey, Currency) - Валюта
- `purpose` (TextField) - Цель дополнительной выдачи

**Примечание:** Дата выдачи хранится в поле `date` базовой модели BaseDocument

**Бизнес-логика:**
- При создании документа автоматически создается операция (Transaction) с отрицательной суммой (расход из кассы)
- Операция привязывается к документу через ForeignKey
- При редактировании документа операция обновляется, а не создается заново
- Дополнительная выдача влияет на расчет остатков подотчетных средств

---

### 3.4. Документы операций

Все документы операций наследуются от `BaseDocument`.

#### 3.4.1. IncomeDocument (Оприходование денег)
**Назначение:** Документ оприходования денежных средств в кассу

**Наследует:** BaseDocument

**Дополнительные поля (к полям BaseDocument):**
- `cash_register` (ForeignKey, CashRegister) - Касса
- `currency` (ForeignKey, Currency) - Валюта
- `amount` (DecimalField) - Сумма оприходования
- `item` (ForeignKey, IncomeExpenseItem) - Статья доходов
- `description` (TextField, blank=True) - Описание
- `employee` (ForeignKey, Employee, null=True, blank=True) - Сотрудник (если применимо)

**Бизнес-логика:**
- При создании документа автоматически создается операция (Transaction) с положительной суммой (поступление в кассу)
- Операция привязывается к документу через ForeignKey
- При редактировании документа операция обновляется, а не создается заново

---

#### 3.4.2. ExpenseDocument (Расход денег)
**Назначение:** Документ расхода денежных средств из кассы

**Наследует:** BaseDocument

**Дополнительные поля (к полям BaseDocument):**
- `cash_register` (ForeignKey, CashRegister) - Касса
- `currency` (ForeignKey, Currency) - Валюта
- `amount` (DecimalField) - Сумма расхода
- `item` (ForeignKey, IncomeExpenseItem) - Статья расходов
- `description` (TextField, blank=True) - Описание
- `employee` (ForeignKey, Employee, null=True, blank=True) - Сотрудник (если применимо)

**Бизнес-логика:**
- При создании документа автоматически создается операция (Transaction) с отрицательной суммой (расход из кассы)
- Операция привязывается к документу через ForeignKey
- При редактировании документа операция обновляется, а не создается заново

---

### 3.5. Журнал операций

#### 3.5.1. Transaction (Операция / Журнал операций)
**Назначение:** Общий журнал операций со ссылками на документы, физические лица, валюты, статьи расходов и доходов

**Наследует:** BaseOperationRegister

**Дополнительные поля (к полям BaseOperationRegister):**
- `transaction_type` (CharField, choices) - Тип операции:
  - 'income' - Оприходование денег
  - 'expense' - Расход денег
  - 'advance_payment' - Выдача подотчетных
  - 'advance_report' - Авансовый отчет (строка отчета)
  - 'advance_return' - Возврат денег сотрудником (отдельный документ возврата)
  - 'advance_return_report' - Возврат денег по авансовому отчету (в рамках авансового отчета)
  - 'additional_advance_payment' - Дополнительная выдача подотчетных средств
  - 'advance_additional' - Доплата по авансовому отчету
  - 'transfer' - Перемещение между кассами
  - 'conversion' - Конвертация валют
- `cash_register` (ForeignKey, CashRegister) - Касса
- `currency` (ForeignKey, Currency) - Валюта
- `item` (ForeignKey, IncomeExpenseItem, null=True, blank=True) - Статья доходов/расходов
- `employee` (ForeignKey, Employee, null=True, blank=True) - Физическое лицо (сотрудник)
- `income_document` (ForeignKey, IncomeDocument, null=True, blank=True) - Документ оприходования
- `expense_document` (ForeignKey, ExpenseDocument, null=True, blank=True) - Документ расхода
- `advance_payment` (ForeignKey, AdvancePayment, null=True, blank=True) - Выдача подотчетных средств
- `advance_report` (ForeignKey, AdvanceReport, null=True, blank=True) - Авансовый отчет
- `advance_report_item` (ForeignKey, AdvanceReportItem, null=True, blank=True) - Строка авансового отчета
- `advance_return` (ForeignKey, AdvanceReturn, null=True, blank=True) - Возврат денег сотрудником (отдельный документ)
- `additional_advance_payment` (ForeignKey, AdditionalAdvancePayment, null=True, blank=True) - Дополнительная выдача подотчетных средств

**Требования:**
- Наследует все поля и поведение от BaseOperationRegister
- Операции привязываются к документам, а не наоборот
- Несколько операций могут быть привязаны к одному документу
- Дата операции устанавливается по дате документа
- Сумма может быть положительной (поступление) или отрицательной (расход)
- Операции из подтвержденных авансовых отчетов отражаются в движениях по остаткам
- Используется для расчета остатков в регистре накоплений

**Индексы:**
- По полям: date, cash_register, currency
- По полям: transaction_type, date
- По полям: employee, date

---

#### 3.5.2. CashTransfer (Перемещение между кассами)
**Назначение:** Документ перемещения денежных средств между кассами

**Наследует:** BaseDocument

**Дополнительные поля (к полям BaseDocument):**
- `from_cash_register` (ForeignKey, CashRegister) - Из кассы
- `to_cash_register` (ForeignKey, CashRegister) - В кассу
- `currency` (ForeignKey, Currency) - Валюта
- `amount` (DecimalField) - Сумма

**Бизнес-логика:**
- При создании документа создаются две операции:
  - Операция списания из исходной кассы (отрицательная сумма)
  - Операция поступления в целевую кассу (положительная сумма)

---

#### 3.5.3. CurrencyConversion (Конвертация валют)
**Назначение:** Документ конвертации валют

**Наследует:** BaseDocument

**Дополнительные поля (к полям BaseDocument):**
- `from_currency` (ForeignKey, Currency) - Из валюты
- `to_currency` (ForeignKey, Currency) - В валюту
- `cash_register` (ForeignKey, CashRegister) - Касса
- `from_amount` (DecimalField) - Сумма в исходной валюте
- `to_amount` (DecimalField) - Сумма в целевой валюте
- `exchange_rate` (DecimalField) - Курс обмена

**Бизнес-логика:**
- При создании документа создаются две операции:
  - Операция списания исходной валюты (отрицательная сумма)
  - Операция поступления целевой валюты (положительная сумма)

---

## 4. Интерфейс пользователя

### 4.1. Django Admin

#### 4.1.1. Общие требования
- Интерфейс на русском языке
- Все модели зарегистрированы в админке
- Поддержка фильтров и поиска
- Использование `raw_id_fields` для оптимизации при большом количестве записей
- Использование `autocomplete_fields` где необходимо

#### 4.1.2. Справочники
- **Currency:** Фильтр по активности, поиск по коду и названию
- **CashRegister:** Отображение остатков по валютам в списке, фильтр по активности
- **IncomeExpenseItem:** Фильтр по типу и активности, поддержка иерархии
- **Employee:** Фильтр по активности, поиск по ФИО и должности

#### 4.1.3. Документы
- **IncomeDocument (Оприходование денег):**
  - Фильтр по кассе, валюте, статье доходов, сотруднику
  - Автоматическое создание/обновление операции при сохранении
  
- **ExpenseDocument (Расход денег):**
  - Фильтр по кассе, валюте, статье расходов, сотруднику
  - Автоматическое создание/обновление операции при сохранении

- **AdvancePayment (Выдача денег подотчетному лицу):**
  - Отображение остатка неотчитанных средств в списке
  - Фильтр по сотруднику, валюте, статье расходов, статусу закрытия
  - Автоматическое создание/обновление операции при сохранении
  
- **AdvanceReport:**
  - Отображение сумм возврата и доплаты в списке
  - Фильтр по сотруднику, статусу, валюте
  - Inline-редактирование строк отчета
  - Поле description в строках - однострочное
  - Автоматический расчет общей суммы из строк
  - Действие для массового подтверждения отчетов
  - Поля для управления закрытием подотчетных средств и ручного указания сумм
  - **Только подтвержденные отчеты отражаются в движениях по остаткам**

- **AdvanceReturn (Возврат денег сотрудником):**
  - Фильтр по сотруднику, валюте, связанной выдаче
  - Автоматическое создание/обновление операции при сохранении
  - Отображение связи с первоначальной выдачей

- **AdditionalAdvancePayment (Дополнительная выдача подотчетных средств):**
  - Фильтр по сотруднику, валюте, связанной первоначальной выдаче
  - Автоматическое создание/обновление операции при сохранении
  - Отображение связи с первоначальной выдачей

- **Transaction (Журнал операций):**
  - Отображение всех связей с документами (income_document, expense_document, advance_payment, advance_report, advance_return, additional_advance_payment)
  - Отображение физического лица (employee)
  - Отображение валюты и статьи доходов/расходов
  - Фильтры по типу, валюте, кассе, дате, сотруднику, статье
  - Иерархия дат для навигации
  - Поиск по описанию

---

## 5. Бизнес-логика

### 5.1. Выдача денег подотчетному лицу

**Процесс:**
1. Создается документ AdvancePayment с указанием сотрудника, кассы, суммы, валюты, статьи расходов и цели выдачи
2. Автоматически создается операция Transaction:
   - Тип: 'advance_payment'
   - Сумма: отрицательная (расход из кассы)
   - Дата: дата документа (date_issued)
   - Привязка к документу через ForeignKey
3. При редактировании документа операция обновляется, а не создается заново

---

### 5.2. Авансовый отчет

**Процесс подтверждения:**
1. При установке статуса 'confirmed' (Подтвержден):
   - Рассчитываются суммы возврата и доплаты
   - Создаются операции по каждой строке отчета (построчно) - только для подтвержденных отчетов
   - Создается операция возврата (если есть возврат)
   - Создается операция доплаты (если есть доплата)
   - Если `close_advance_payment=True`, подотчетные средства закрываются
   - Если `close_advance_payment=False` и есть доплата, создается новая выдача подотчетных средств
   - **Операции отражаются в движениях по остаткам**

2. При редактировании подтвержденного отчета:
   - Операции по строкам обновляются
   - Операции возврата/доплаты обновляются
   - Удаляются операции для удаленных строк

3. При изменении статуса с 'confirmed' на другой:
   - ⚠️ **ТРЕБУЕТСЯ УТОЧНЕНИЕ:** Операции остаются в журнале, но не влияют на остатки (или удаляются - уточнить)

**Расчет сумм:**
- Общая сумма (`total_amount`) автоматически рассчитывается из суммы всех строк, если не заполнена
- Сумма возврата (`return_amount`) = выданная сумма - общая сумма расходов (если расходы меньше)
- Сумма доплаты (`additional_payment`) = общая сумма расходов - выданная сумма (если расходы больше)
- Используются ручные суммы (`manual_return_amount`, `manual_additional_payment`), если они указаны

**Закрытие выдачи подотчетных средств:**
- Каждый документ выдачи денег (AdvancePayment) может быть закрыт одним или несколькими авансовыми отчетами
- Выдача считается закрытой, когда сумма всех подтвержденных отчетов по ней равна сумме выдачи (с учетом возвратов и доплат)
- При расчете остатков учитываются также отдельные документы возврата (AdvanceReturn) и дополнительные выдачи (AdditionalAdvancePayment)

---

**Требование:** При закрытии (подтверждении) сотрудником ранее выданных подотчетных средств в авансовом отчете, строки отчета должны использовать строго ту же статью расходов, по которой была произведена первоначальная выдача денег.

**Реализация:**
- При создании строк авансового отчета система должна проверять соответствие статей расходов в строках отчета (AdvanceReportItem.item) статье расходов, указанной при выдаче подотчетных средств (AdvancePayment.expense_item)
- Валидация должна выполняться на уровне формы и модели при сохранении авансового отчета
- Если в строке отчета указана статья расходов, отличная от статьи расходов при выдаче, система должна заблокировать сохранение отчета до исправления статьи расходов
- Валидация является обязательной и не может быть отключена

---

### 5.3. Возврат денег сотрудником (отдельный документ)

**Процесс:**
1. Создается документ AdvanceReturn с привязкой к выданным подотчетным средствам (AdvancePayment)
2. Указывается сумма возврата (полный или частичный возврат от первоначальной выдачи)
3. Автоматически создается операция Transaction:
   - Тип: 'advance_return'
   - Сумма: положительная (поступление в кассу)
   - Дата: дата документа
   - Привязка к документу через ForeignKey
4. При редактировании документа операция обновляется, а не создается заново
5. Возврат влияет на расчет остатков подотчетных средств

**Особенности:**
- Возможен полный или частичный возврат от первоначальной выдачи
- Возврат может быть создан независимо от авансового отчета
- Возврат учитывается при расчете остатков подотчетных средств

---

### 5.4. Дополнительная выдача подотчетных средств

**Процесс:**
1. Создается документ AdditionalAdvancePayment с привязкой к первоначальной выдаче (AdvancePayment)
2. Указывается сумма дополнительной выдачи, цель выдачи
3. Автоматически создается операция Transaction:
   - Тип: 'additional_advance_payment'
   - Сумма: отрицательная (расход из кассы)
   - Дата: дата документа
   - Привязка к документу через ForeignKey
4. При редактировании документа операция обновляется, а не создается заново
5. Дополнительная выдача влияет на расчет остатков подотчетных средств

**Особенности:**
- Дополнительная выдача привязана к первоначальной выдаче
- Дополнительная выдача учитывается при расчете остатков подотчетных средств

---

### 5.5. Расчет остатков

**Остатки по кассам:**
- Рассчитываются на основе всех операций (Transaction) по кассе и валюте
- Поддерживается расчет на определенную дату
- Метод: `CashRegister.get_balance(currency, date=None)`
- Остатки хранятся в системе и рассчитываются динамически на основе операций

**Остатки по выданным авансам сотрудникам:**
- Рассчитываются на основе:
  - Выданных сумм (AdvancePayment + AdditionalAdvancePayment)
  - Минус суммы подтвержденных отчетов (AdvanceReport)
  - Минус суммы возвратов (AdvanceReturn + возвраты по авансовым отчетам)
  - Плюс суммы доплат (доплаты по авансовым отчетам)
- Метод: `Employee.get_advance_balance(currency)` - остаток по сотруднику в указанной валюте
- Метод: `AdvancePayment.get_unreported_balance()` - остаток неотчитанных средств по конкретной выдаче (с учетом дополнительных выдач, возвратов и доплат)
- Остатки хранятся в системе и рассчитываются динамически на основе операций
- **Учитываются только операции из подтвержденных авансовых отчетов**
- **Учитываются все операции возврата (отдельные документы и возвраты по авансовым отчетам)**
- **Учитываются все дополнительные выдачи подотчетных средств**

---

## 6. Отчеты

Система должна обеспечивать формирование отчетности для анализа финансового состояния и движения денежных средств. Все отчеты формируются на основе данных из регистра операций и регистра накоплений.

### 6.1. Отчет о текущем состоянии остатков по кассам

**Назначение:** Просмотр текущего состояния остатков денежных средств по всем кассам и валютам на определенную дату

**Параметры отчета:**
- Дата отчета (обязательный параметр)

**Функциональность:**
- Форма выбора даты отчета
- Таблица с остатками по кассам и валютам на выбранную дату
- Структура таблицы:
  - Касса
  - Валюта
  - Остаток на дату
- Строка итогов по каждой валюте (сумма остатков по всем кассам)
- Отображение нулевых остатков
- Возможность экспорта в Excel/CSV (опционально)

**Алгоритм расчета:**
- Остатки рассчитываются на основе всех операций (Transaction) по кассе и валюте на дату отчета
- Используется метод: `CashRegister.get_balance(currency, date=report_date)`

**URL:** `/reports/cash-balance/`

---

### 6.2. Отчет об операциях и движениях денег за период

**Назначение:** Анализ всех операций и движений денежных средств за выбранный период с отображением входящих и исходящих остатков

**Параметры отчета:**
- Дата начала периода (обязательный параметр)
- Дата окончания периода (обязательный параметр)
- Касса (опциональный параметр, для фильтрации)
- Валюта (опциональный параметр, для фильтрации)

**Функциональность:**
- Форма выбора периода (дата начала и дата окончания)
- Форма выбора кассы (опционально, для фильтрации по конкретной кассе)
- Форма выбора валюты (опционально, для фильтрации по конкретной валюте)
- Таблица с операциями за период:
  - Дата операции
  - Тип операции
  - Номер и дата документа-основания
  - Касса
  - Валюта
  - Сотрудник (если применимо)
  - Статья доходов/расходов
  - Сумма (положительная для поступлений, отрицательная для расходов)
  - Описание операции
- Входящий остаток на начало периода:
  - По каждой кассе и валюте
  - Рассчитывается на дату начала периода
- Исходящий остаток на конец периода:
  - По каждой кассе и валюте
  - Рассчитывается на дату окончания периода
- Обороты за период:
  - Приход (сумма всех положительных операций)
  - Расход (сумма всех отрицательных операций)
  - Чистый оборот (приход - расход)
- Итоги по кассам и валютам:
  - Входящий остаток
  - Приход за период
  - Расход за период
  - Исходящий остаток
- Группировка по кассам и валютам
- Возможность экспорта в Excel/CSV (опционально)

**Алгоритм расчета:**
- Входящий остаток = сумма всех операций до даты начала периода (включительно)
- Исходящий остаток = сумма всех операций до даты окончания периода (включительно)
- Приход = сумма всех положительных операций за период
- Расход = сумма всех отрицательных операций за период
- Исходящий остаток = Входящий остаток + Приход - Расход

**URL:** `/reports/transactions-period/`

---

### 6.3. Отчет об остатках по подотчетным деньгам

**Назначение:** Анализ остатков подотчетных средств с детализацией по выдачам, отчетам, возвратам и доплатам

**Параметры отчета:**
- Дата отчета (обязательный параметр)
- Сотрудник (опциональный параметр, для фильтрации)
- Валюта (опциональный параметр, для фильтрации)

**Функциональность:**
- Форма выбора даты отчета
- Форма выбора сотрудника (опционально, для фильтрации по конкретному сотруднику)
- Форма выбора валюты (опционально, для фильтрации по конкретной валюте)
- Сводная таблица с остатками по подотчетным средствам:
  - Сотрудник
  - Валюта
  - Выданная сумма (сумма всех выдач подотчетных средств)
  - Отчитанная сумма (сумма всех подтвержденных авансовых отчетов)
  - Возвращенная сумма (сумма всех возвратов денег)
  - Доплаченная сумма (сумма всех доплат)
  - Текущий остаток (неотчитанные средства) = Выданная сумма - Отчитанная сумма + Доплаченная сумма - Возвращенная сумма
- Детализация по каждому сотруднику (раскрываемая секция):
  - **Выдачи подотчетных средств:**
    - Номер документа
    - Дата выдачи
    - Сумма
    - Валюта
    - Цель выдачи
    - Статус (открыта/закрыта)
  - **Авансовые отчеты:**
    - Номер документа
    - Дата отчета
    - Сумма расходов
    - Сумма возврата
    - Сумма доплаты
    - Статус (черновик/сдан/подтвержден/отклонен)
    - Связь с выдачей подотчетных средств
  - **Возвраты денег:**
    - Дата возврата
    - Сумма
    - Валюта
    - Тип возврата (отдельный документ возврата или возврат по авансовому отчету)
    - Связь с выдачей подотчетных средств (для отдельного документа возврата)
    - Связь с авансовым отчетом (для возврата по авансовому отчету)
  - **Доплаты:**
    - Дата доплаты
    - Сумма
    - Валюта
    - Связь с авансовым отчетом
  - **Дополнительные выдачи:**
    - Номер документа
    - Дата выдачи
    - Сумма
    - Валюта
    - Цель выдачи
    - Связь с первоначальной выдачей подотчетных средств
- Итоги по валютам:
  - Общая выданная сумма
  - Общая отчитанная сумма
  - Общая возвращенная сумма
  - Общая доплаченная сумма
  - Общий остаток
- Возможность экспорта в Excel/CSV (опционально)

**Алгоритм расчета:**
- Выданная сумма = сумма всех документов AdvancePayment + сумма всех документов AdditionalAdvancePayment по сотруднику и валюте
- Отчитанная сумма = сумма всех подтвержденных авансовых отчетов (status='confirmed') по сотруднику и валюте
- Возвращенная сумма = сумма всех операций возврата (transaction_type='advance_return' - отдельный документ возврата, transaction_type='advance_return_report' - возврат по авансовому отчету) по сотруднику и валюте
- Доплаченная сумма = сумма всех операций доплаты (transaction_type='advance_additional') по сотруднику и валюте
- Текущий остаток = Выданная сумма - Отчитанная сумма + Доплаченная сумма - Возвращенная сумма
- Используются методы: `Employee.get_advance_balance(currency)` и `AdvancePayment.get_unreported_balance()`

**URL:** `/reports/advance-balance/`

---

### 6.4. Касса по дням

**Назначение:** Детальный отчет по операциям с подотчетными средствами, включающий выдачи, возвраты и авансовые отчеты с указанием прихода и расхода

**Параметры отчета:**
- Дата начала периода (обязательный параметр)
- Дата окончания периода (обязательный параметр)
- Сотрудник (опциональный параметр, для фильтрации)
- Валюта (опциональный параметр, для фильтрации)

**Функциональность:**
- Форма выбора периода (дата начала и дата окончания)
- Форма выбора сотрудника (опционально, для фильтрации по конкретному сотруднику)
- Форма выбора валюты (опционально, для фильтрации по конкретной валюте)
- Таблица с операциями по подотчетным средствам за период:
  - № документа выдачи / возврата / авансового отчета
  - Дата документа
  - От кого получено или кому выдано (сотрудник)
  - Приход (положительные суммы: возвраты денег, доплаты по авансовым отчетам)
  - Расход (отрицательные суммы: выдачи подотчетных средств, расходы по авансовым отчетам)
  - Основание (описание операции, цель выдачи, описание строки авансового отчета)
  - Валюта
- Итоги по приходу и расходу:
  - Общий приход за период
  - Общий расход за период
  - Чистый оборот (приход - расход)
- Группировка по сотрудникам и валютам (опционально)
- Возможность экспорта в Excel/CSV (опционально)

**Алгоритм расчета:**
- Отчет формируется на основе операций (Transaction) с типами:
  - `advance_payment` - выдача подотчетных средств (отображается как расход)
  - `additional_advance_payment` - дополнительная выдача подотчетных средств (отображается как расход)
  - `advance_return` - возврат денег сотрудником (отдельный документ возврата, отображается как приход)
  - `advance_return_report` - возврат денег по авансовому отчету (в рамках авансового отчета, отображается как приход)
  - `advance_additional` - доплата по авансовому отчету (отображается как приход)
  - `advance_report` - строка авансового отчета (отображается как расход)
- Приход = сумма всех положительных операций по подотчетным средствам за период
- Расход = сумма всех отрицательных операций по подотчетным средствам за период (по модулю)
- Номер документа берется из связанного документа (AdvancePayment, AdditionalAdvancePayment, AdvanceReturn, AdvanceReport)
- Описание формируется из:
  - Для выдачи: поле `purpose` из документа AdvancePayment или AdditionalAdvancePayment
  - Для авансового отчета: поле `description` из строки AdvanceReportItem
  - Для возврата (отдельный документ): поле `description` из документа AdvanceReturn
  - Для возврата/доплаты по авансовому отчету: описание из операции Transaction

**URL:** `/reports/advance-operations/`

---

### 6.5. Отчет «Расход денежных средств по статьям»

**Назначение:** Анализ расходов денежных средств по статьям расходов с детализацией по документам расхода и остатками неотчитанных/не возвращенных подотчетных средств

**Параметры отчета:**
- Дата начала периода (обязательный параметр)
- Дата окончания периода (обязательный параметр)
- Касса (опциональный параметр, для фильтрации)
- Валюта (опциональный параметр, для фильтрации)

**Функциональность:**
- Форма выбора периода (дата начала и дата окончания)
- Форма выбора кассы (опционально, для фильтрации по конкретной кассе)
- Форма выбора валюты (опционально, для фильтрации по конкретной валюте)
- Таблица с группировкой по статьям расходов:
  - **Статья расходов** (заголовок группы)
  - **Строки с документами расхода:**
    - Дата документа расхода
    - Номер документа расхода
    - Сумма расхода
    - Касса
    - Валюта
    - Сотрудник (если применимо)
    - Описание
    - Остаток не подтвержденных или не возвращенных денег (для расходов, связанных с подотчетными средствами)
  - **Итог по статье расходов:**
    - Общая сумма расходов по статье за период
    - Общий остаток неотчитанных/не возвращенных средств
- Итоги по всем статьям расходов:
  - Общая сумма расходов за период
  - Общий остаток неотчитанных/не возвращенных средств
- Группировка по статьям расходов (иерархическая структура поддерживается)
- Возможность экспорта в Excel/CSV (опционально)

**Алгоритм расчета:**
- Отчет формируется на основе документов расхода (ExpenseDocument) за выбранный период
- Фильтрация по кассе и валюте (если указаны)
- Группировка по статьям расходов (IncomeExpenseItem с type='expense')
- Для каждого документа расхода:
  - Если документ связан с подотчетными средствами (через сотрудника и операции):
    - Рассчитывается остаток неотчитанных/не возвращенных средств по связанным выдачам подотчетных средств
    - Остаток = сумма выданных подотчетных средств - сумма подтвержденных отчетов - сумма возвратов + сумма доплат
  - Если документ не связан с подотчетными средствами, остаток = 0
- Итог по статье = сумма всех расходов по статье за период
- Общий остаток по статье = сумма остатков неотчитанных/не возвращенных средств по всем документам расхода в статье

**Особенности:**
- Поддержка иерархической структуры статей расходов (отображение родительских и дочерних статей)
- Отображение только активных статей расходов
- Сортировка по названию статьи расходов
- Сортировка документов расхода по дате (от старых к новым)

**URL:** `/reports/expenses-by-items/`

---

## 7. Технические требования

### 7.1. База данных

**Разработка:**
- Использование SQLite для разработки и тестирования
- SQLite встроена в Python, не требует дополнительной установки
- Настройка через `settings.py`:
  ```python
  DATABASES = {
      'default': {
          'ENGINE': 'django.db.backends.sqlite3',
          'NAME': BASE_DIR / 'db.sqlite3',
      }
  }
  ```

**Промышленное применение:**
- Использование PostgreSQL для промышленного применения
- Требуется установка PostgreSQL и драйвера `psycopg2` или `psycopg2-binary`
- Настройка через `settings.py`:
  ```python
  DATABASES = {
      'default': {
          'ENGINE': 'django.db.backends.postgresql',
          'NAME': 'fin_count',
          'USER': 'user',
          'PASSWORD': 'password',
          'HOST': 'localhost',
          'PORT': '5432',
      }
  }
  ```
- Переключение между базами данных осуществляется через переменные окружения или настройки в `settings.py`
- Все модели должны быть совместимы с обеими базами данных (использование только стандартных типов полей Django)

### 7.2. Производительность
- Индексы на часто используемых полях
- Оптимизация запросов через select_related/prefetch_related
- Использование raw_id_fields для больших таблиц
- Учет особенностей производительности PostgreSQL при больших объемах данных

### 7.3. Безопасность
- Валидация данных на уровне моделей
- Защита от SQL-инъекций (ORM Django)
- Контроль доступа через Django Admin
- Безопасное хранение учетных данных базы данных (переменные окружения)

### 7.4. Масштабируемость
- Абстрактные модели для переиспользования
- Модульная структура приложения
- Возможность расширения функциональности
- Поддержка миграций для обеих баз данных

---

## 8. Этапы реализации

### 8.1. Абстрактные базовые модели
- [ ] BaseDocument (Документ) - абстрактная модель с UUID первичным ключом
- [ ] BaseOperationRegister (Регистр операций) - абстрактная модель
- [ ] BaseAccumulationRegister (Регистр накоплений) - абстрактная модель
- [ ] BaseReference (Справочники) - абстрактная модель с UUID первичным ключом

### 8.2. Справочники
- [ ] Currency (Валюта) - конкретная модель, наследуется от BaseReference
- [ ] CashRegister (Касса) - конкретная модель, наследуется от BaseReference
- [ ] IncomeExpenseItem (Статья доходов/расходов) - конкретная модель, наследуется от BaseReference
- [ ] Employee (Сотрудник) - конкретная модель, наследуется от BaseReference

### 8.3. Регистр операций
- [ ] Transaction (Операция) - конкретная модель, наследуется от BaseOperationRegister

### 8.4. Документы
- [ ] IncomeDocument (Оприходование денег)
- [ ] ExpenseDocument (Расход денег)
- [ ] AdvancePayment (Выдача денег подотчетному лицу)
- [ ] AdvanceReport (Авансовый отчет)
- [ ] AdvanceReportItem (Строки отчета)
- [ ] AdvanceReturn (Возврат денег сотрудником - отдельный документ)
- [ ] AdditionalAdvancePayment (Дополнительная выдача подотчетных средств)
- [ ] CashTransfer (Перемещение между кассами)
- [ ] CurrencyConversion (Конвертация валют)

### 8.5. Бизнес-логика
- [ ] Базовые методы расчета остатков в BaseAccumulationRegister (используют регистр накоплений)
- [ ] Автоматическое создание операций при создании документов (IncomeDocument, ExpenseDocument, AdvancePayment, AdvanceReturn, AdditionalAdvancePayment)
- [ ] Логика подтверждения авансовых отчетов (только подтвержденные отражаются в остатках)
- [ ] Расчет возврата и доплаты
- [ ] Управление закрытием подотчетных средств (один документ выдачи может закрываться несколькими отчетами)
- [ ] Расчет остатков по кассам и по выданным авансам (с учетом возвратов, дополнительных выдач и доплат)

### 8.6. Интерфейс
- [ ] Регистрация всех моделей в админке
- [ ] Настройка фильтров и поиска
- [ ] Inline-редактирование
- [ ] Автоматический расчет сумм в формах

### 8.7. Отчеты
- [ ] Отчет о текущем состоянии остатков по кассам
- [ ] Отчет об операциях и движениях денег за период
- [ ] Отчет об остатках по подотчетным деньгам
- [ ] Касса по дням
- [ ] Отчет «Расход денежных средств по статьям»
- [ ] Формы для параметров отчетов
- [ ] Экспорт отчетов в Excel/CSV (опционально)

---

## 9. Примечания

- Все даты операций устанавливаются по дате документа
- Операции привязываются к документам, а не наоборот
- Поддержка мультивалютного учета обязательна
- Интерфейс полностью на русском языке
- Проект работает в режиме отладки с доступом на всех IP-адресах
- **Остатки хранятся в системе по кассам и по выданным авансам сотрудникам**
- **Только подтвержденные авансовые отчеты отражаются в движениях по остаткам**
- **Каждый документ выдачи денег закрывается одним или несколькими авансовыми отчетами**
- **Возврат денег может осуществляться как отдельным документом (AdvanceReturn), так и в рамках авансового отчета**
- **Дополнительная выдача подотчетных средств (AdditionalAdvancePayment) привязана к первоначальной выдаче и учитывается при расчете остатков**
- **Журнал операций (Transaction) - это общий журнал со ссылками на документы, физические лица, валюты, статьи расходов и доходов**
- **ВАЖНО: Закрытие (подтверждение) сотрудником ранее выданных денег должно происходить строго по той же статье расходов, по которой деньги выдавались. Система должна выполнять обязательную валидацию соответствия статей расходов при создании авансового отчета и блокировать сохранение отчета при несоответствии.**

---

**Статус документа:** Черновик  
**Дата последнего обновления:** 08.11.2025

